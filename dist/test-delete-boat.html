<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Suppression Bateau - SailingLoc</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .log-container {
      background: #1e1e1e;
      color: #00ff00;
      padding: 15px;
      border-radius: 5px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .error { color: #ff6b6b; }
    .success { color: #51cf66; }
    .warning { color: #ffd43b; }
    .info { color: #74c0fc; }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover { background: #0056b3; }
    .danger { background: #dc3545; }
    .danger:hover { background: #c82333; }
    .data-display {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin: 10px 0;
      border-left: 4px solid #007bff;
    }
    .boat-item {
      background: #e9ecef;
      padding: 10px;
      margin: 5px 0;
      border-radius: 5px;
      border-left: 4px solid #28a745;
    }
    input {
      padding: 8px;
      margin: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 200px;
    }
  </style>
  <script type="module" src="/assets/main.js"></script>
  <link rel="stylesheet" crossorigin href="/assets/style-t4_5AYKD.css">
</head>
<body>
  <div class="container">
    <h1>ğŸ—‘ï¸ Test Suppression Bateau - SailingLoc</h1>
    <p>Cette page teste la suppression de bateaux avec diagnostics dÃ©taillÃ©s.</p>
    
    <div>
      <button onclick="checkAuth()">ğŸ” VÃ©rifier Auth</button>
      <button onclick="loadMyBoats()">ğŸš¢ Charger Mes Bateaux</button>
      <button onclick="clearLogs()">ğŸ§¹ Effacer les logs</button>
    </div>
    
    <div>
      <h3>ğŸ§ª Test de suppression manuel</h3>
      <input type="text" id="boatId" placeholder="ID du bateau Ã  supprimer">
      <button onclick="testDeleteBoat()" class="danger">ğŸ—‘ï¸ Tester Suppression</button>
      <button onclick="testDeleteBoatForce()" class="danger">ğŸ’¥ Suppression ForcÃ©e</button>
    </div>
    
    <div class="data-display">
      <h3>ğŸ“Š RÃ©sultats</h3>
      <div id="results"></div>
    </div>
    
    <div>
      <h3>ğŸ“ Logs</h3>
      <div id="logs" class="log-container">Logs de test...\n</div>
    </div>
  </div>

  <!-- Script principal de l'application -->
  
  <script>
    function log(message, type = 'info') {
      const logsContainer = document.getElementById('logs');
      const timestamp = new Date().toLocaleTimeString();
      const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
      logsContainer.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
      logsContainer.scrollTop = logsContainer.scrollHeight;
      console.log(`[DELETE-TEST] ${message}`);
    }

    function clearLogs() {
      document.getElementById('logs').innerHTML = 'Logs effacÃ©s...\n';
      document.getElementById('results').innerHTML = '';
    }

    async function checkAuth() {
      log('ğŸ” VÃ©rification de l\'authentification...', 'info');
      
      const token = localStorage.getItem('authToken');
      if (!token) {
        log('âŒ Aucun token d\'authentification trouvÃ©', 'error');
        log('ğŸ’¡ Connectez-vous d\'abord sur l\'application principale', 'info');
        return;
      }

      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        log('âœ… Token dÃ©codÃ© avec succÃ¨s', 'success');
        log(`ğŸ“Š User ID: ${payload.userId}`, 'info');
        log(`ğŸ“Š Email: ${payload.email}`, 'info');
        log(`ğŸ“Š Role: ${payload.role}`, 'info');
        
        // VÃ©rifier l'expiration
        const exp = payload.exp * 1000;
        const now = Date.now();
        if (exp > now) {
          log('âœ… Token valide (non expirÃ©)', 'success');
        } else {
          log('âŒ Token expirÃ©', 'error');
          return;
        }
      } catch (error) {
        log(`âŒ Erreur de dÃ©codage du token: ${error.message}`, 'error');
        return;
      }

      // Tester l'API avec le token
      try {
        const response = await fetch('https://sailingloc.onrender.com/api/auth/me', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const userData = await response.json();
          log('âœ… Informations utilisateur rÃ©cupÃ©rÃ©es', 'success');
          log(`ğŸ“Š Utilisateur: ${JSON.stringify(userData, null, 2)}`, 'info');
        } else {
          log(`âŒ Erreur API: ${response.status} ${response.statusText}`, 'error');
        }
      } catch (error) {
        log(`âŒ Erreur: ${error.message}`, 'error');
      }
    }

    async function loadMyBoats() {
      log('ğŸš¢ Chargement de mes bateaux...', 'info');
      
      const token = localStorage.getItem('authToken');
      if (!token) {
        log('âŒ Aucun token d\'authentification trouvÃ©', 'error');
        return;
      }

      try {
        const response = await fetch('https://sailingloc.onrender.com/api/boats/owner/my-boats', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const data = await response.json();
          log('âœ… Bateaux rÃ©cupÃ©rÃ©s avec succÃ¨s', 'success');
          
          if (data.success && data.data.boats.length > 0) {
            log(`ğŸ“Š ${data.data.boats.length} bateau(x) trouvÃ©(s)`, 'info');
            displayMyBoats(data.data.boats);
          } else {
            log('ğŸ“­ Aucun bateau trouvÃ©', 'warning');
            document.getElementById('results').innerHTML = '<p>ğŸ“­ Vous n\'avez aucun bateau enregistrÃ©</p>';
          }
        } else {
          const errorData = await response.json();
          log(`âŒ Erreur API: ${errorData.message}`, 'error');
          log(`ğŸ“Š Status: ${response.status}`, 'error');
        }
      } catch (error) {
        log(`âŒ Erreur: ${error.message}`, 'error');
      }
    }

    function displayMyBoats(boats) {
      const resultsDiv = document.getElementById('results');
      
      resultsDiv.innerHTML = `
        <div class="boat-item">
          <h4>ğŸš¢ Mes Bateaux (${boats.length})</h4>
          ${boats.map(boat => `
            <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
              <p><strong>Nom:</strong> ${boat.name}</p>
              <p><strong>ID:</strong> ${boat._id}</p>
              <p><strong>PropriÃ©taire:</strong> ${boat.owner?.firstName} ${boat.owner?.lastName}</p>
              <p><strong>PropriÃ©taire ID:</strong> ${boat.owner?._id}</p>
              <p><strong>Statut:</strong> ${boat.isActive ? 'Actif' : 'Inactif'}</p>
              <button onclick="testDeleteBoatById('${boat._id}', '${boat.name}')" class="danger" style="margin-top: 5px;">
                ğŸ—‘ï¸ Tester Suppression
              </button>
            </div>
          `).join('')}
        </div>
      `;
    }

    async function testDeleteBoatById(boatId, boatName) {
      log(`ğŸ—‘ï¸ Test de suppression du bateau: ${boatName} (${boatId})`, 'info');
      await performDeleteBoat(boatId, false);
    }

    async function testDeleteBoat() {
      const boatId = document.getElementById('boatId').value.trim();
      if (!boatId) {
        log('âŒ Veuillez entrer un ID de bateau', 'error');
        return;
      }
      
      log(`ğŸ—‘ï¸ Test de suppression du bateau: ${boatId}`, 'info');
      await performDeleteBoat(boatId, false);
    }

    async function testDeleteBoatForce() {
      const boatId = document.getElementById('boatId').value.trim();
      if (!boatId) {
        log('âŒ Veuillez entrer un ID de bateau', 'error');
        return;
      }
      
      log(`ğŸ’¥ Test de suppression forcÃ©e du bateau: ${boatId}`, 'warning');
      await performDeleteBoat(boatId, true);
    }

    async function performDeleteBoat(boatId, force = false) {
      const token = localStorage.getItem('authToken');
      if (!token) {
        log('âŒ Aucun token d\'authentification trouvÃ©', 'error');
        return;
      }

      try {
        const url = `https://sailingloc.onrender.com/api/boats/${boatId}${force ? '?force=true' : ''}`;
        log(`ğŸ“¡ URL: ${url}`, 'info');
        
        const response = await fetch(url, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();
        
        log(`ğŸ“Š Status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
        log(`ğŸ“Š RÃ©ponse: ${JSON.stringify(data, null, 2)}`, 'info');
        
        if (response.ok) {
          log('âœ… Bateau supprimÃ© avec succÃ¨s', 'success');
        } else {
          log(`âŒ Erreur de suppression: ${data.message}`, 'error');
          
          if (response.status === 403) {
            log('ğŸ’¡ Erreur 403: ProblÃ¨me de permissions', 'warning');
            log('ğŸ’¡ VÃ©rifiez que vous Ãªtes le propriÃ©taire du bateau', 'info');
            log('ğŸ’¡ VÃ©rifiez que votre token est valide', 'info');
          } else if (response.status === 404) {
            log('ğŸ’¡ Erreur 404: Bateau non trouvÃ©', 'warning');
          } else if (response.status === 400) {
            log('ğŸ’¡ Erreur 400: RÃ©servations actives - utilisez force=true', 'warning');
          }
        }

      } catch (error) {
        log(`âŒ Erreur: ${error.message}`, 'error');
      }
    }

    // Initialisation
    log('ğŸš€ Page de test de suppression chargÃ©e', 'success');
    log('ğŸ’¡ Cliquez sur "VÃ©rifier Auth" pour commencer', 'info');
    
    // VÃ©rification automatique
    setTimeout(() => {
      checkAuth();
    }, 1000);
  </script>
</body>
</html>
