import"./AuthService-DvEDo84p.js";/* empty css              */import{A as v}from"./init-CUDXmtww.js";import{g as B}from"./apiConfig-Hw5SgeDb.js";class P{constructor(n=null){this.stripe=null,this.elements=null,this.paymentElement=null,this.isInitialized=!1,this.appStateService=n,window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"?this.baseURL="/api":this.baseURL="https://sailingloc.onrender.com/api"}getAuthToken(){return this.appStateService?this.appStateService.getAuthToken():localStorage.getItem("authToken")}async initialize(){if(!this.isInitialized)try{if(!window.Stripe){const n=document.createElement("script");n.src="https://js.stripe.com/v3/",n.async=!0,document.head.appendChild(n),await new Promise((t,a)=>{n.onload=t,n.onerror=a})}this.stripe=window.Stripe("pk_live_51RrIXsCOaiVcTD9sZVaREYZc3QTQNeU8VQZ5VUDddHUNiPGVpMN1oiREmM3UcCBqdTfXF2SjO9YjGKsVy7iinX9n00bQXl4cig"),this.isInitialized=!0,console.log("âœ… Stripe initialisÃ© avec succÃ¨s")}catch(n){throw console.error("âŒ Erreur lors de l'initialisation de Stripe:",n),n}}async createPaymentSession(n){try{const t=this.getAuthToken();if(console.log("ğŸ”‘ Token rÃ©cupÃ©rÃ©:",t?"PrÃ©sent":"Absent"),console.log("ğŸ”‘ Token complet:",t),!t)throw new Error("Vous devez Ãªtre connectÃ© pour effectuer un paiement");console.log("ğŸ“¤ DonnÃ©es envoyÃ©es au serveur:",n);const a=await fetch(`${this.baseURL}/payments/create-session`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(n)});if(console.log("ğŸ“¥ RÃ©ponse du serveur:",a.status,a.statusText),!a.ok){let u=`Erreur HTTP: ${a.status}`;try{const d=await a.json();console.log("ğŸ“¥ DÃ©tails de l'erreur:",d),u=d.message||u}catch{console.log("ğŸ“¥ Impossible de parser la rÃ©ponse d'erreur")}throw new Error(u)}const c=await a.json();return console.log("âœ… Session de paiement crÃ©Ã©e:",c),c}catch(t){throw console.error("âŒ Erreur lors de la crÃ©ation de la session de paiement:",t),t}}async verifySession(n){try{const t=await fetch(`${this.baseURL}/payments/verify-session/${n}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!t.ok)throw new Error(`Erreur HTTP: ${t.status}`);const a=await t.json();return console.log("âœ… Session vÃ©rifiÃ©e:",a),a}catch(t){throw console.error("âŒ Erreur lors de la vÃ©rification de la session:",t),t}}async createPaymentElements(n){try{this.stripe||await this.initialize();const t=this.stripe.elements({clientSecret:n,appearance:{theme:"stripe",variables:{colorPrimary:"#2f7fe0",colorBackground:"#ffffff",colorText:"#30313d",colorDanger:"#df1b41",fontFamily:"Inter, system-ui, sans-serif",spacingUnit:"4px",borderRadius:"8px"}}});return this.paymentElement=t.create("payment"),this.paymentElement}catch(t){throw console.error("âŒ Erreur lors de la crÃ©ation des Ã©lÃ©ments de paiement:",t),t}}async confirmPayment(n,t){try{if(!this.stripe||!this.paymentElement)throw new Error("Stripe non initialisÃ©");const{error:a,paymentIntent:c}=await this.stripe.confirmPayment({elements:this.stripe.elements({clientSecret:n}),confirmParams:{return_url:t},redirect:"if_required"});if(a)throw console.error("âŒ Erreur de paiement:",a),new Error(a.message);return console.log("âœ… Paiement confirmÃ©:",c),c}catch(a){throw console.error("âŒ Erreur lors de la confirmation du paiement:",a),a}}async retrievePaymentIntent(n){try{this.stripe||await this.initialize();const t=await this.stripe.retrievePaymentIntent(n);return console.log("âœ… PaymentIntent rÃ©cupÃ©rÃ©:",t),t}catch(t){throw console.error("âŒ Erreur lors de la rÃ©cupÃ©ration du PaymentIntent:",t),t}}}const i=new v,p=new P(i),m=new URLSearchParams(window.location.search),b=m.get("boatId"),y=m.get("startDate"),g=m.get("endDate"),I=m.get("passengers");let o=null,s=null;const r={boatImage:document.getElementById("boat-image"),noImage:document.getElementById("no-image"),boatName:document.getElementById("boat-name"),boatType:document.getElementById("boat-type"),boatLocation:document.getElementById("boat-location"),startDate:document.getElementById("start-date"),endDate:document.getElementById("end-date"),passengers:document.getElementById("passengers"),duration:document.getElementById("duration"),dailyRate:document.getElementById("daily-rate"),daysCount:document.getElementById("days-count"),subtotal:document.getElementById("subtotal"),serviceFee:document.getElementById("service-fee"),totalPrice:document.getElementById("total-price"),payButton:document.getElementById("pay-button"),payButtonText:document.getElementById("pay-button-text"),payButtonAmount:document.getElementById("pay-button-amount"),errorMessage:document.getElementById("error-message"),successMessage:document.getElementById("success-message")};document.addEventListener("DOMContentLoaded",async()=>{try{await T()}catch(e){console.error("âŒ Erreur lors de l'initialisation:",e),l("Une erreur est survenue lors du chargement de la page.")}});async function T(){var e;if(console.log("ğŸ”„ VÃ©rification de l'authentification..."),i.isInitialized||await i.initialize(),await i.waitForInitialization(),!i.isAuthenticated()){console.log("âŒ Utilisateur non authentifiÃ©, redirection vers login"),l("Vous devez Ãªtre connectÃ© pour effectuer un paiement."),setTimeout(()=>{window.location.href="/login.html"},3e3);return}if(console.log("âœ… Utilisateur authentifiÃ©, continuation du processus de paiement"),console.log("ğŸ”‘ Token disponible:",i.getAuthToken()?"Oui":"Non"),console.log("ğŸ‘¤ Utilisateur actuel:",((e=i.currentUser)==null?void 0:e.firstName)||"Non dÃ©fini"),!b||!y||!g||!I){l("ParamÃ¨tres de rÃ©servation manquants. Veuillez recommencer.");return}await D(),S(),$(),x(),C()}async function D(){try{const e=await fetch(`${B()}/boats/${b}`);if(!e.ok)throw new Error(`Erreur HTTP: ${e.status}`);s=(await e.json()).data.boat,console.log("âœ… DonnÃ©es du bateau chargÃ©es:",s)}catch(e){throw console.error("âŒ Erreur lors du chargement du bateau:",e),e}}function S(){var h,f,w;const e=new Date(y),n=new Date(g),t=Math.ceil((n-e)/(1e3*60*60*24)),a=s.pricing.dailyRate,c=t*a,u=Math.round(c*.05),d=c+u;o={boatId:s._id,boatName:s.name,startDate:y,endDate:g,totalPrice:d,customerEmail:(h=i.currentUser)==null?void 0:h.email,customerName:`${(f=i.currentUser)==null?void 0:f.firstName} ${(w=i.currentUser)==null?void 0:w.lastName}`,passengers:parseInt(I),days:t,dailyRate:a,subtotal:c,serviceFee:u,total:d,currency:s.pricing.currency||"EUR"},console.log("âœ… DÃ©tails de la rÃ©servation calculÃ©s:",o),console.log("ğŸ” VÃ©rification des champs requis:"),console.log("ğŸ” boatId:",o.boatId?"âœ…":"âŒ"),console.log("ğŸ” boatName:",o.boatName?"âœ…":"âŒ"),console.log("ğŸ” startDate:",o.startDate?"âœ…":"âŒ"),console.log("ğŸ” endDate:",o.endDate?"âœ…":"âŒ"),console.log("ğŸ” totalPrice:",o.totalPrice?"âœ…":"âŒ"),console.log("ğŸ” customerEmail:",o.customerEmail?"âœ…":"âŒ"),console.log("ğŸ” customerName:",o.customerName?"âœ…":"âŒ")}function x(){const e=document.getElementById("breadcrumb-boat-name");e&&s&&(e.textContent=s.name||"Bateau")}function $(){if(s.images&&s.images.length>0){const e=s.images.find(n=>n.isMain)||s.images[0];e&&e.url&&(r.boatImage.src=`https://sailingloc.onrender.com${e.url}`,r.boatImage.style.display="block",r.noImage.style.display="none")}r.boatName.textContent=s.name,r.boatType.textContent=`${s.type} â€¢ ${s.category}`,r.boatLocation.textContent=`${s.location.city}, ${s.location.marina}, ${s.location.country} â€¢ ${s.capacity.maxPeople} pers.`,r.startDate.textContent=E(o.startDate),r.endDate.textContent=E(o.endDate),r.passengers.textContent=o.passengers,r.duration.textContent=`${o.days} jour${o.days>1?"s":""}`,r.dailyRate.textContent=`${o.dailyRate} ${o.currency}`,r.daysCount.textContent=o.days,r.subtotal.textContent=`${o.subtotal} ${o.currency}`,r.serviceFee.textContent=`${o.serviceFee} ${o.currency}`,r.totalPrice.textContent=`${o.total} ${o.currency}`,r.payButtonAmount.textContent=`${o.total} ${o.currency}`}function C(){r.payButton.addEventListener("click",async()=>{try{await U()}catch(e){console.error("âŒ Erreur lors du paiement:",e),l("Une erreur est survenue lors du paiement. Veuillez rÃ©essayer.")}})}async function U(){try{if(!i.isAuthenticated()){console.log("âŒ Session expirÃ©e lors du paiement"),l("Session expirÃ©e. Veuillez vous reconnecter."),setTimeout(()=>{window.location.href="/login.html"},2e3);return}r.payButton.disabled=!0,r.payButtonText.textContent="Traitement en cours...",r.payButton.classList.add("loading"),await p.initialize();const e=await p.createPaymentSession(o);console.log("âœ… Session de paiement crÃ©Ã©e:",e),await p.redirectToCheckout(e.sessionId)}catch(e){console.error("âŒ Erreur lors du traitement du paiement:",e),e.message.includes("connectÃ©")||e.message.includes("authentification")?(l("Session expirÃ©e. Veuillez vous reconnecter."),setTimeout(()=>{window.location.href="/login.html"},2e3)):l(e.message||"Une erreur est survenue lors du paiement."),r.payButton.disabled=!1,r.payButtonText.textContent="Payer maintenant",r.payButton.classList.remove("loading")}}function l(e){r.errorMessage.textContent=e,r.errorMessage.style.display="flex",r.successMessage.style.display="none"}function E(e){return new Date(e).toLocaleDateString("fr-FR",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}window.addEventListener("error",e=>{console.error("âŒ Erreur globale:",e.error),l("Une erreur inattendue est survenue.")});window.addEventListener("unhandledrejection",e=>{console.error("âŒ Promesse rejetÃ©e:",e.reason),l("Une erreur est survenue lors du traitement.")});
