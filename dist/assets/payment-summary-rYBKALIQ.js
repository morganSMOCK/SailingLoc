import"./AuthService-BR8AMDic.js";/* empty css              */import"./init-CvdFLqyy.js";import{g as E}from"./apiConfig-Hw5SgeDb.js";class b{constructor(){this.stripe=null,this.elements=null,this.paymentElement=null,this.isInitialized=!1,window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"?this.baseURL="/api":this.baseURL="https://sailingloc.onrender.com/api"}async initialize(){if(!this.isInitialized)try{if(!window.Stripe){const r=document.createElement("script");r.src="https://js.stripe.com/v3/",r.async=!0,document.head.appendChild(r),await new Promise((t,s)=>{r.onload=t,r.onerror=s})}this.stripe=window.Stripe("pk_live_51RrIXsCOaiVcTD9sZVaREYZc3QTQNeU8VQZ5VUDddHUNiPGVpMN1oiREmM3UcCBqdTfXF2SjO9YjGKsVy7iinX9n00bQXl4cig"),this.isInitialized=!0,console.log("✅ Stripe initialisé avec succès")}catch(r){throw console.error("❌ Erreur lors de l'initialisation de Stripe:",r),r}}async createPaymentSession(r){try{const t=await fetch(`${this.baseURL}/payments/create-session`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!t.ok)throw new Error(`Erreur HTTP: ${t.status}`);return await t.json()}catch(t){throw console.error("❌ Erreur lors de la création de la session de paiement:",t),t}}async redirectToCheckout(r){try{const{error:t}=await this.stripe.redirectToCheckout({sessionId:r});if(t)throw new Error(t.message)}catch(t){throw console.error("❌ Erreur lors de la redirection vers Stripe:",t),t}}async verifySession(r){try{const t=await fetch(`${this.baseURL}/payments/verify-session/${r}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!t.ok)throw new Error(`Erreur HTTP: ${t.status}`);return await t.json()}catch(t){throw console.error("❌ Erreur lors de la vérification de la session:",t),t}}async createPaymentElement(r,t){try{await this.initialize();const s=this.stripe.elements({clientSecret:r,appearance:{theme:"stripe",variables:{colorPrimary:"#667eea",colorBackground:"#ffffff",colorText:"#1e293b",colorDanger:"#dc2626",fontFamily:"Inter, system-ui, sans-serif",spacingUnit:"4px",borderRadius:"12px"}}});return this.paymentElement=s.create("payment"),this.paymentElement.mount(`#${t}`),this.paymentElement}catch(s){throw console.error("❌ Erreur lors de la création de l'élément de paiement:",s),s}}async confirmPayment(r,t={}){try{const{error:s,paymentIntent:c}=await this.stripe.confirmPayment({elements:this.elements,clientSecret:r,confirmParams:{return_url:`${window.location.origin}/booking-confirmation.html`,...t}});if(s)throw new Error(s.message);return c}catch(s){throw console.error("❌ Erreur lors de la confirmation du paiement:",s),s}}}const d=new b,l=new URLSearchParams(window.location.search),g=l.get("boatId"),u=l.get("startDate"),m=l.get("endDate"),h=l.get("passengers");let o=null,a=null;const n={boatImage:document.getElementById("boat-image"),noImage:document.getElementById("no-image"),boatName:document.getElementById("boat-name"),boatType:document.getElementById("boat-type"),boatLocation:document.getElementById("boat-location"),startDate:document.getElementById("start-date"),endDate:document.getElementById("end-date"),passengers:document.getElementById("passengers"),duration:document.getElementById("duration"),dailyRate:document.getElementById("daily-rate"),daysCount:document.getElementById("days-count"),subtotal:document.getElementById("subtotal"),serviceFee:document.getElementById("service-fee"),totalPrice:document.getElementById("total-price"),payButton:document.getElementById("pay-button"),payButtonText:document.getElementById("pay-button-text"),payButtonAmount:document.getElementById("pay-button-amount"),errorMessage:document.getElementById("error-message"),successMessage:document.getElementById("success-message")};document.addEventListener("DOMContentLoaded",async()=>{try{await f()}catch(e){console.error("❌ Erreur lors de l'initialisation:",e),i("Une erreur est survenue lors du chargement de la page.")}});async function f(){if(!g||!u||!m||!h){i("Paramètres de réservation manquants. Veuillez recommencer.");return}await B(),I(),v(),$(),C()}async function B(){try{const e=await fetch(`${E()}/boats/${g}`);if(!e.ok)throw new Error(`Erreur HTTP: ${e.status}`);a=(await e.json()).data.boat,console.log("✅ Données du bateau chargées:",a)}catch(e){throw console.error("❌ Erreur lors du chargement du bateau:",e),e}}function I(){const e=new Date(u),r=new Date(m),t=Math.ceil((r-e)/(1e3*60*60*24)),s=a.pricing.dailyRate,c=t*s,y=Math.round(c*.05),w=c+y;o={boatId:a._id,boatName:a.name,startDate:u,endDate:m,passengers:parseInt(h),days:t,dailyRate:s,subtotal:c,serviceFee:y,total:w,currency:a.pricing.currency||"EUR"},console.log("✅ Détails de la réservation calculés:",o)}function $(){const e=document.getElementById("breadcrumb-boat-name");e&&a&&(e.textContent=a.name||"Bateau")}function v(){if(a.images&&a.images.length>0){const e=a.images.find(r=>r.isMain)||a.images[0];e&&e.url&&(n.boatImage.src=`https://sailingloc.onrender.com${e.url}`,n.boatImage.style.display="block",n.noImage.style.display="none")}n.boatName.textContent=a.name,n.boatType.textContent=`${a.type} • ${a.category}`,n.boatLocation.textContent=`${a.location.city}, ${a.location.marina}, ${a.location.country} • ${a.capacity.maxPeople} pers.`,n.startDate.textContent=p(o.startDate),n.endDate.textContent=p(o.endDate),n.passengers.textContent=o.passengers,n.duration.textContent=`${o.days} jour${o.days>1?"s":""}`,n.dailyRate.textContent=`${o.dailyRate} ${o.currency}`,n.daysCount.textContent=o.days,n.subtotal.textContent=`${o.subtotal} ${o.currency}`,n.serviceFee.textContent=`${o.serviceFee} ${o.currency}`,n.totalPrice.textContent=`${o.total} ${o.currency}`,n.payButtonAmount.textContent=`${o.total} ${o.currency}`}function C(){n.payButton.addEventListener("click",async()=>{try{await x()}catch(e){console.error("❌ Erreur lors du paiement:",e),i("Une erreur est survenue lors du paiement. Veuillez réessayer.")}})}async function x(){try{n.payButton.disabled=!0,n.payButtonText.textContent="Traitement en cours...",n.payButton.classList.add("loading"),await d.initialize();const e=await d.createPaymentSession(o);console.log("✅ Session de paiement créée:",e),await d.redirectToCheckout(e.sessionId)}catch(e){console.error("❌ Erreur lors du traitement du paiement:",e),i(e.message||"Une erreur est survenue lors du paiement."),n.payButton.disabled=!1,n.payButtonText.textContent="Payer maintenant",n.payButton.classList.remove("loading")}}function i(e){n.errorMessage.textContent=e,n.errorMessage.style.display="flex",n.successMessage.style.display="none"}function p(e){return new Date(e).toLocaleDateString("fr-FR",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}window.addEventListener("error",e=>{console.error("❌ Erreur globale:",e.error),i("Une erreur inattendue est survenue.")});window.addEventListener("unhandledrejection",e=>{console.error("❌ Promesse rejetée:",e.reason),i("Une erreur est survenue lors du traitement.")});
