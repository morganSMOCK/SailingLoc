/* empty css              */class R{constructor(){this.baseURL="https://sailingloc.onrender.com/api",this.authEndpoint=`${this.baseURL}/auth`}async register(e){try{const t=await fetch(`${this.authEndpoint}/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});console.log("📡 Réponse HTTP:",{status:t.status,statusText:t.statusText,ok:t.ok,url:t.url});let r;try{r=await t.json(),console.log("📊 Données JSON reçues:",r)}catch(o){console.error("❌ Erreur parsing JSON:",o);const a=await t.text();throw console.log("📄 Réponse texte:",a),new Error(`Réponse invalide du serveur: ${t.status}`)}if(!t.ok)throw console.error("❌ Réponse HTTP non-OK:",t.status,r),new Error(r.message||"Erreur lors de l'inscription");return r}catch(t){throw console.error("❌ Erreur AuthService.register:",t),t}}async login(e,t){try{const r=`${this.authEndpoint}/login`;console.log("🔐 AuthService.login appelé"),console.log("📍 URL:",r),console.log("📊 Données:",{email:e,password:t?"***":"vide"});const o=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})});console.log("📡 Réponse HTTP:",{status:o.status,statusText:o.statusText,ok:o.ok,url:o.url});let a;try{a=await o.json(),console.log("📊 Données JSON reçues:",a)}catch(s){console.error("❌ Erreur parsing JSON:",s);const n=await o.text();throw console.log("📄 Réponse texte:",n),new Error(`Réponse invalide du serveur: ${o.status}`)}if(!o.ok)throw console.error("❌ Réponse HTTP non-OK:",o.status,a),new Error(a.message||"Erreur lors de la connexion");return a}catch(r){throw console.error("❌ Erreur AuthService.login:",r),r}}async logout(){try{const e=this.getAuthToken(),t=`${this.authEndpoint}/logout`;console.log("🚪 AuthService.logout appelé"),console.log("📍 URL:",t);const r=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",...e?{Authorization:`Bearer ${e}`}:{}}});let o;try{o=await r.json()}catch{o={success:r.ok}}if(!r.ok)throw new Error(o.message||"Erreur lors de la déconnexion");return this.clearAuthData(),o}catch(e){throw console.error("Erreur lors de la déconnexion:",e),this.clearAuthData(),e}}async getProfile(){try{const e=this.getAuthToken();if(!e)throw new Error("Token d'authentification manquant");const t=await fetch(`${this.authEndpoint}/profile`,{method:"GET",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}}),r=await t.json();if(!t.ok)throw new Error(r.message||"Erreur lors de la récupération du profil");return r}catch(e){throw console.error("Erreur lors de la récupération du profil:",e),e}}async updateProfile(e){try{const t=this.getAuthToken();if(!t)throw new Error("Token d'authentification manquant");const r=await fetch(`${this.authEndpoint}/profile`,{method:"PUT",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify(e)}),o=await r.json();if(!r.ok)throw new Error(o.message||"Erreur lors de la mise à jour du profil");return o}catch(t){throw console.error("Erreur lors de la mise à jour du profil:",t),t}}async changePassword(e,t){try{const r=this.getAuthToken();if(!r)throw new Error("Token d'authentification manquant");const o=await fetch(`${this.authEndpoint}/change-password`,{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},body:JSON.stringify({currentPassword:e,newPassword:t})}),a=await o.json();if(!o.ok)throw new Error(a.message||"Erreur lors du changement de mot de passe");return a}catch(r){throw console.error("Erreur lors du changement de mot de passe:",r),r}}async verifyToken(){try{const e=this.getAuthToken();if(!e)throw new Error("Aucun token trouvé");const t=await fetch(`${this.authEndpoint}/verify-token`,{method:"GET",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}}),r=await t.json();if(!t.ok)throw new Error(r.message||"Token invalide");return r}catch(e){throw console.error("Erreur lors de la vérification du token:",e),e}}getAuthToken(){try{return localStorage.getItem("sailingloc_token")}catch(e){return console.error("Erreur lors de la récupération du token:",e),null}}isAuthenticated(){const e=this.getAuthToken();if(!e)return!1;try{const t=JSON.parse(atob(e.split(".")[1])),r=Date.now()/1e3;return t.exp>r}catch(t){return console.error("Token invalide:",t),!1}}getCurrentUser(){try{const e=localStorage.getItem("sailingloc_user");return e?JSON.parse(e):null}catch(e){return console.error("Erreur lors de la récupération des données utilisateur:",e),null}}clearAuthData(){try{localStorage.removeItem("sailingloc_token"),localStorage.removeItem("sailingloc_user")}catch(e){console.error("Erreur lors du nettoyage des données d'authentification:",e)}}handleAuthError(e){return(e.message.includes("Token")||e.message.includes("401"))&&this.clearAuthData(),{success:!1,message:e.message||"Erreur d'authentification",error:e}}async refreshToken(){try{const e=this.getAuthToken();if(!e)throw new Error("Aucun token à rafraîchir");const t=await fetch(`${this.authEndpoint}/refresh-token`,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}}),r=await t.json();if(!t.ok)throw new Error(r.message||"Erreur lors du rafraîchissement du token");return r.data&&r.data.token&&localStorage.setItem("sailingloc_token",r.data.token),r}catch(e){throw console.error("Erreur lors du rafraîchissement du token:",e),this.clearAuthData(),e}}async authenticatedFetch(e,t={}){const r=this.getAuthToken();if(!r)throw new Error("Authentification requise");const o={...t,headers:{...t.headers,Authorization:`Bearer ${r}`,"Content-Type":"application/json"}};try{const a=await fetch(e,o);if(a.status===401)try{await this.refreshToken();const s=this.getAuthToken();return o.headers.Authorization=`Bearer ${s}`,await fetch(e,o)}catch{throw this.clearAuthData(),new Error("Session expirée, veuillez vous reconnecter")}return a}catch(a){throw console.error("Erreur lors de la requête authentifiée:",a),a}}}class F{constructor(){this.baseURL="https://sailingloc.onrender.com/api",this.boatsEndpoint=`${this.baseURL}/boats`}async getBoats(e={}){try{const t=new URLSearchParams;Object.keys(e).forEach(s=>{e[s]!==void 0&&e[s]!==""&&t.append(s,e[s])});const r=`${this.boatsEndpoint}?${t.toString()}`;console.log("🚤 Tentative de connexion à:",r);const o=await fetch(r,{method:"GET",headers:{"Content-Type":"application/json"},mode:"cors"});if(console.log("📡 Réponse reçue:",o.status,o.statusText),!o.ok){const s=await o.text();throw console.error("❌ Erreur API:",o.status,s),new Error(`Erreur ${o.status}: ${s}`)}const a=await o.json();return console.log("✅ Données reçues:",a),a}catch(t){throw console.error("❌ Erreur lors de la récupération des bateaux:",t),t}}getMockBoats(e={}){let r=[{_id:"68c717e123456789abcdef01",name:"Ocean Dream",type:"Yacht",category:"Luxe",status:"available",location:{city:"Cannes",country:"France",marina:"Port de Cannes"},pricing:{dailyRate:850,securityDeposit:2e3},capacity:{maxPeople:8},specifications:{length:15,width:4.5,fuelType:"Diesel"},images:[{url:"https://images.pexels.com/photos/1001682/pexels-photo-1001682.jpeg?auto=compress&cs=tinysrgb&w=600&h=400&fit=crop",isMain:!0}],rating:{average:4.8,totalReviews:24}},{_id:"68c717e123456789abcdef02",name:"Blue Horizon",type:"Catamaran",category:"Standard",status:"available",location:{city:"Nice",country:"France",marina:"Port de Nice"},pricing:{dailyRate:650,securityDeposit:1500},capacity:{maxPeople:10},specifications:{length:12,width:6,fuelType:"Diesel"},images:[{url:"https://images.pexels.com/photos/1001682/pexels-photo-1001682.jpeg?auto=compress&cs=tinysrgb&w=600&h=400&fit=crop",isMain:!0}],rating:{average:4.6,totalReviews:18}},{_id:"68c717e123456789abcdef03",name:"Sea Breeze",type:"Voilier",category:"Budget",status:"available",location:{city:"Saint-Tropez",country:"France",marina:"Port de Saint-Tropez"},pricing:{dailyRate:450,securityDeposit:1e3},capacity:{maxPeople:6},specifications:{length:10,width:3.5,fuelType:"Voile"},images:[{url:"https://images.pexels.com/photos/1001682/pexels-photo-1001682.jpeg?auto=compress&cs=tinysrgb&w=600&h=400&fit=crop",isMain:!0}],rating:{average:4.2,totalReviews:12}}];e.type&&(r=r.filter(c=>c.type.toLowerCase().includes(e.type.toLowerCase()))),e.category&&(r=r.filter(c=>c.category.toLowerCase()===e.category.toLowerCase())),e.minPrice&&(r=r.filter(c=>c.pricing.dailyRate>=parseInt(e.minPrice))),e.maxPrice&&(r=r.filter(c=>c.pricing.dailyRate<=parseInt(e.maxPrice)));const o=parseInt(e.page)||1,a=parseInt(e.limit)||12,s=(o-1)*a,n=s+a;return{success:!0,data:{boats:r.slice(s,n),pagination:{page:o,limit:a,total:r.length,pages:Math.ceil(r.length/a)}}}}async getBoatById(e){try{const t=await fetch(`${this.boatsEndpoint}/${e}`,{method:"GET",headers:{"Content-Type":"application/json"}}),r=await t.json();if(!t.ok)throw new Error(r.message||"Erreur lors de la récupération du bateau");return r}catch(t){throw console.error("Erreur lors de la récupération du bateau:",t),t}}async createBoat(e){try{const t=this.getAuthToken();if(!t)throw new Error("Authentification requise");const r=await fetch(this.boatsEndpoint,{method:"POST",headers:{Authorization:`Bearer ${t}`},body:e}),o=await r.json();if(!r.ok)throw new Error(o.message||"Erreur lors de la création du bateau");return o}catch(t){throw console.error("Erreur lors de la création du bateau:",t),t}}async updateBoat(e,t){try{const r=this.getAuthToken();if(!r)throw new Error("Authentification requise");const o=await fetch(`${this.boatsEndpoint}/${e}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify(t)}),a=await o.json();if(!o.ok)throw new Error(a.message||"Erreur lors de la mise à jour du bateau");return a}catch(r){throw console.error("Erreur lors de la mise à jour du bateau:",r),r}}async getOwnerBoats(e={}){try{const t=this.getAuthToken();if(!t)throw new Error("Authentification requise");const r=new URLSearchParams(e),o=`${this.boatsEndpoint}/owner/my-boats?${r.toString()}`,a=await fetch(o,{method:"GET",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}}),s=await a.json();if(!a.ok)throw new Error(s.message||"Erreur lors de la récupération des bateaux");return s}catch(t){throw console.error("Erreur lors de la récupération des bateaux du propriétaire:",t),t}}async checkAvailability(e,t,r){try{const o=new URLSearchParams({startDate:t,endDate:r}),a=await fetch(`${this.boatsEndpoint}/${e}/availability?${o.toString()}`,{method:"GET",headers:{"Content-Type":"application/json"}}),s=await a.json();if(!a.ok)throw new Error(s.message||"Erreur lors de la vérification de disponibilité");return s}catch(o){throw console.error("Erreur lors de la vérification de disponibilité:",o),o}}async searchNearby(e,t,r=5e4){try{const o=new URLSearchParams({latitude:e.toString(),longitude:t.toString(),maxDistance:r.toString()}),a=await fetch(`${this.boatsEndpoint}/search/nearby?${o.toString()}`,{method:"GET",headers:{"Content-Type":"application/json"}}),s=await a.json();if(!a.ok)throw new Error(s.message||"Erreur lors de la recherche par proximité");return s}catch(o){throw console.error("Erreur lors de la recherche par proximité:",o),o}}async getOwnerBoats(e={}){var t,r;try{const o=this.getAuthToken();if(!o)throw console.error("❌ [BOAT SERVICE] Token manquant pour getOwnerBoats"),new Error("Authentification requise");console.log("🚤 [BOAT SERVICE] Récupération des bateaux du propriétaire"),console.log("🔐 [BOAT SERVICE] Token présent:",o?"Oui":"Non");const a=new URLSearchParams;Object.keys(e).forEach(c=>{e[c]!==void 0&&e[c]!==""&&a.append(c,e[c])});const s=`${this.boatsEndpoint}/owner/my-boats?${a.toString()}`;console.log("📡 [BOAT SERVICE] URL getOwnerBoats:",s);const n=await fetch(s,{method:"GET",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}});console.log("📡 [BOAT SERVICE] Réponse getOwnerBoats:",{status:n.status,statusText:n.statusText,ok:n.ok});const i=await n.json();if(!n.ok)throw console.error("❌ [BOAT SERVICE] Erreur getOwnerBoats:",i),n.status===401?new Error("Authentification requise - Token expiré ou invalide"):n.status===403?new Error("Permissions insuffisantes pour accéder aux bateaux"):new Error(i.message||"Erreur lors de la récupération des bateaux du propriétaire");return console.log("✅ [BOAT SERVICE] Bateaux récupérés avec succès:",((r=(t=i.data)==null?void 0:t.boats)==null?void 0:r.length)||0,"bateaux"),i}catch(o){throw console.error("❌ [BOAT SERVICE] Erreur lors de la récupération des bateaux du propriétaire:",o),o}}async getBoatStats(){try{const e=this.getAuthToken();if(!e)throw console.error("❌ [BOAT SERVICE] Token manquant pour getBoatStats"),new Error("Authentification requise");console.log("📊 [BOAT SERVICE] Récupération des statistiques des bateaux"),console.log("🔐 [BOAT SERVICE] Token présent:",e?"Oui":"Non");const t=await fetch(`${this.boatsEndpoint}/stats/overview`,{method:"GET",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});console.log("📡 [BOAT SERVICE] Réponse getBoatStats:",{status:t.status,statusText:t.statusText,ok:t.ok});const r=await t.json();if(!t.ok)throw console.error("❌ [BOAT SERVICE] Erreur getBoatStats:",r),t.status===401?new Error("Authentification requise - Token expiré ou invalide"):t.status===403?new Error("Permissions insuffisantes pour accéder aux statistiques"):new Error(r.message||"Erreur lors de la récupération des statistiques");return console.log("✅ [BOAT SERVICE] Statistiques récupérées avec succès"),r}catch(e){throw console.error("❌ [BOAT SERVICE] Erreur lors de la récupération des statistiques:",e),e}}async uploadBoatImages(e,t){try{const r=this.getAuthToken();if(!r)throw new Error("Authentification requise");const o=new FormData;Array.from(t).forEach((n,i)=>{o.append("images",n)});const a=await fetch(`${this.boatsEndpoint}/${e}/images`,{method:"POST",headers:{Authorization:`Bearer ${r}`},body:o}),s=await a.json();if(!a.ok)throw new Error(s.message||"Erreur lors de l'upload des images");return s}catch(r){throw console.error("Erreur lors de l'upload des images:",r),r}}async deleteBoatImage(e,t){try{const r=this.getAuthToken();if(!r)throw new Error("Authentification requise");const o=await fetch(`${this.boatsEndpoint}/${e}/images/${t}`,{method:"DELETE",headers:{Authorization:`Bearer ${r}`}}),a=await o.json();if(!o.ok)throw new Error(a.message||"Erreur lors de la suppression de l'image");return a}catch(r){throw console.error("Erreur lors de la suppression de l'image:",r),r}}async updateBoat(e,t,r=null){try{const o=this.getAuthToken();if(!o)throw new Error("Authentification requise");const a=new FormData;Object.keys(t).forEach(i=>{t[i]!==void 0&&t[i]!==null&&(typeof t[i]=="object"?a.append(i,JSON.stringify(t[i])):a.append(i,t[i]))}),r&&r.length>0&&r.forEach(i=>{a.append("images",i)});const s=await fetch(`${this.boatsEndpoint}/${e}`,{method:"PUT",headers:{Authorization:`Bearer ${o}`},body:a}),n=await s.json();if(!s.ok)throw new Error(n.message||"Erreur lors de la mise à jour du bateau");return n}catch(o){throw console.error("Erreur lors de la mise à jour du bateau:",o),o}}async deleteBoat(e,t=!1){try{const r=this.getAuthToken();if(!r)throw console.error("❌ [BOAT SERVICE] Token manquant pour la suppression"),new Error("Authentification requise");console.log("🗑️ [BOAT SERVICE] Suppression du bateau:",e),console.log("🔐 [BOAT SERVICE] Token présent:",r?"Oui":"Non"),console.log("🔐 [BOAT SERVICE] Token (premiers caractères):",r?r.substring(0,20)+"...":"N/A");const o=t?"?force=true":"",a=`${this.boatsEndpoint}/${e}${o}`;console.log("📡 [BOAT SERVICE] URL de suppression:",a);const s=await fetch(a,{method:"DELETE",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}});console.log("📡 [BOAT SERVICE] Réponse HTTP:",{status:s.status,statusText:s.statusText,ok:s.ok});const n=await s.json();if(!s.ok)throw console.error("❌ [BOAT SERVICE] Erreur de suppression:",n),s.status===401?new Error("Authentification requise - Token expiré ou invalide"):s.status===403?new Error("Permissions insuffisantes pour supprimer ce bateau"):new Error(n.message||"Erreur lors de la suppression du bateau");return console.log("✅ [BOAT SERVICE] Suppression réussie:",n),n}catch(r){throw console.error("❌ [BOAT SERVICE] Erreur lors de la suppression du bateau:",r),r}}async restoreBoat(e){try{const t=this.getAuthToken();if(!t)throw new Error("Authentification requise");const r=await fetch(`${this.boatsEndpoint}/${e}/restore`,{method:"PUT",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}}),o=await r.json();if(!r.ok)throw new Error(o.message||"Erreur lors de la restauration du bateau");return o}catch(t){throw console.error("Erreur lors de la restauration du bateau:",t),t}}async setMainImage(e,t){try{const r=this.getAuthToken();if(!r)throw new Error("Authentification requise");const o=await fetch(`${this.boatsEndpoint}/${e}/images/${t}/main`,{method:"PUT",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}}),a=await o.json();if(!o.ok)throw new Error(a.message||"Erreur lors de la définition de l'image principale");return a}catch(r){throw console.error("Erreur lors de la définition de l'image principale:",r),r}}getBoatTypes(){return[{value:"voilier",label:"Voilier"},{value:"catamaran",label:"Catamaran"},{value:"yacht",label:"Yacht"},{value:"bateau_moteur",label:"Bateau à moteur"},{value:"semi_rigide",label:"Semi-rigide"},{value:"peniche",label:"Péniche"}]}getBoatCategories(){return[{value:"luxe",label:"Luxe"},{value:"standard",label:"Standard"},{value:"economique",label:"Économique"},{value:"sportif",label:"Sportif"},{value:"familial",label:"Familial"}]}validateBoatData(e){const t=[];return(!e.name||e.name.trim().length===0)&&t.push("Le nom du bateau est obligatoire"),(!e.description||e.description.trim().length===0)&&t.push("La description est obligatoire"),e.type||t.push("Le type de bateau est obligatoire"),e.category||t.push("La catégorie est obligatoire"),e.specifications?((!e.specifications.length||e.specifications.length<=0)&&t.push("La longueur doit être positive"),(!e.specifications.width||e.specifications.width<=0)&&t.push("La largeur doit être positive")):t.push("Les spécifications sont obligatoires"),e.capacity?(!e.capacity.maxPeople||e.capacity.maxPeople<=0)&&t.push("Le nombre maximum de personnes doit être positif"):t.push("La capacité est obligatoire"),e.location?((!e.location.marina||e.location.marina.trim().length===0)&&t.push("Le port d'attache est obligatoire"),(!e.location.city||e.location.city.trim().length===0)&&t.push("La ville est obligatoire")):t.push("La localisation est obligatoire"),e.pricing?((!e.pricing.dailyRate||e.pricing.dailyRate<=0)&&t.push("Le tarif journalier doit être positif"),(!e.pricing.securityDeposit||e.pricing.securityDeposit<0)&&t.push("La caution ne peut pas être négative")):t.push("Les tarifs sont obligatoires"),{isValid:t.length===0,errors:t}}getAuthToken(){try{if(window.app&&window.app.storageManager){const t=window.app.storageManager.getToken();return console.log("🔐 [BOAT SERVICE] Token récupéré via StorageManager:",t?"Présent":"Absent"),t}const e=localStorage.getItem("sailingloc_token");return console.log("🔐 [BOAT SERVICE] Token récupéré via localStorage:",e?"Présent":"Absent"),e}catch(e){return console.error("Erreur lors de la récupération du token:",e),null}}formatBoatForDisplay(e){var t,r,o,a,s,n;return{...e,formattedPrice:`${e.pricing.dailyRate}€/jour`,formattedCapacity:`${e.capacity.maxPeople} personnes`,formattedLength:`${e.specifications.length}m`,formattedLocation:`${e.location.city}, ${e.location.country}`,mainImage:((r=(t=e.images)==null?void 0:t.find(i=>i.isMain))==null?void 0:r.url)||((a=(o=e.images)==null?void 0:o[0])==null?void 0:a.url),rating:{...e.rating,formattedAverage:((n=(s=e.rating)==null?void 0:s.average)==null?void 0:n.toFixed(1))||"0.0"}}}calculateTotalPrice(e,t,r){const o=new Date(t),a=new Date(r),s=Math.ceil((a-o)/(1e3*60*60*24));let n=0;if(s>=30&&e.pricing.monthlyRate){const i=Math.floor(s/30),c=s%30;n=i*e.pricing.monthlyRate+c*e.pricing.dailyRate}else if(s>=7&&e.pricing.weeklyRate){const i=Math.floor(s/7),c=s%7;n=i*e.pricing.weeklyRate+c*e.pricing.dailyRate}else n=s*e.pricing.dailyRate;return{days:s,subtotal:n,cleaningFee:e.pricing.cleaningFee||0,securityDeposit:e.pricing.securityDeposit,total:n+(e.pricing.cleaningFee||0)}}}class O{constructor(){this.baseURL="https://sailingloc.onrender.com/api",this.bookingsEndpoint=`${this.baseURL}/bookings`}async createBooking(e){try{const t=this.getAuthToken();if(!t)throw new Error("Authentification requise");const r=await fetch(this.bookingsEndpoint,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(e)}),o=await r.json();if(!r.ok)throw new Error(o.message||"Erreur lors de la création de la réservation");return o}catch(t){throw console.error("Erreur lors de la création de la réservation:",t),t}}async getUserBookings(e={}){try{const t=this.getAuthToken();if(!t)throw new Error("Authentification requise");const r=new URLSearchParams;Object.keys(e).forEach(n=>{e[n]!==void 0&&e[n]!==""&&r.append(n,e[n])});const o=`${this.bookingsEndpoint}?${r.toString()}`,a=await fetch(o,{method:"GET",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}}),s=await a.json();if(!a.ok)throw new Error(s.message||"Erreur lors de la récupération des réservations");return s}catch(t){throw console.error("Erreur lors de la récupération des réservations:",t),t}}async getBookingById(e){try{const t=this.getAuthToken();if(!t)throw new Error("Authentification requise");const r=await fetch(`${this.bookingsEndpoint}/${e}`,{method:"GET",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}}),o=await r.json();if(!r.ok)throw new Error(o.message||"Erreur lors de la récupération de la réservation");return o}catch(t){throw console.error("Erreur lors de la récupération de la réservation:",t),t}}async confirmBooking(e){try{const t=this.getAuthToken();if(!t)throw new Error("Authentification requise");const r=await fetch(`${this.bookingsEndpoint}/${e}/confirm`,{method:"PUT",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}}),o=await r.json();if(!r.ok)throw new Error(o.message||"Erreur lors de la confirmation de la réservation");return o}catch(t){throw console.error("Erreur lors de la confirmation de la réservation:",t),t}}async cancelBooking(e,t=""){try{const r=this.getAuthToken();if(!r)throw new Error("Authentification requise");const o=await fetch(`${this.bookingsEndpoint}/${e}/cancel`,{method:"PUT",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},body:JSON.stringify({reason:t})}),a=await o.json();if(!o.ok)throw new Error(a.message||"Erreur lors de l'annulation de la réservation");return a}catch(r){throw console.error("Erreur lors de l'annulation de la réservation:",r),r}}async checkIn(e,t){try{const r=this.getAuthToken();if(!r)throw new Error("Authentification requise");const o=await fetch(`${this.bookingsEndpoint}/${e}/checkin`,{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},body:JSON.stringify(t)}),a=await o.json();if(!o.ok)throw new Error(a.message||"Erreur lors du check-in");return a}catch(r){throw console.error("Erreur lors du check-in:",r),r}}async checkOut(e,t){try{const r=this.getAuthToken();if(!r)throw new Error("Authentification requise");const o=await fetch(`${this.bookingsEndpoint}/${e}/checkout`,{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},body:JSON.stringify(t)}),a=await o.json();if(!o.ok)throw new Error(a.message||"Erreur lors du check-out");return a}catch(r){throw console.error("Erreur lors du check-out:",r),r}}async addReview(e,t,r){try{const o=this.getAuthToken();if(!o)throw new Error("Authentification requise");const a=await fetch(`${this.bookingsEndpoint}/${e}/review`,{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify({rating:t,comment:r})}),s=await a.json();if(!a.ok)throw new Error(s.message||"Erreur lors de l'ajout de l'avis");return s}catch(o){throw console.error("Erreur lors de l'ajout de l'avis:",o),o}}async getBookingStats(){try{const e=this.getAuthToken();if(!e)throw new Error("Authentification requise");const t=await fetch(`${this.bookingsEndpoint}/stats/overview`,{method:"GET",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}}),r=await t.json();if(!t.ok)throw new Error(r.message||"Erreur lors de la récupération des statistiques");return r}catch(e){throw console.error("Erreur lors de la récupération des statistiques:",e),e}}validateBookingData(e){const t=[];if(e.boatId||t.push("L'ID du bateau est obligatoire"),e.startDate||t.push("La date de début est obligatoire"),e.endDate||t.push("La date de fin est obligatoire"),e.startDate&&e.endDate){const r=new Date(e.startDate),o=new Date(e.endDate),a=new Date;a.setHours(0,0,0,0),r<a&&t.push("La date de début ne peut pas être dans le passé"),o<=r&&t.push("La date de fin doit être postérieure à la date de début");const s=new Date;s.setFullYear(s.getFullYear()+1),r>s&&t.push("La réservation ne peut pas être faite plus d'un an à l'avance")}return e.participants?((!e.participants.adults||e.participants.adults<1)&&t.push("Il doit y avoir au moins 1 adulte"),e.participants.children&&e.participants.children<0&&t.push("Le nombre d'enfants ne peut pas être négatif")):t.push("Les informations sur les participants sont obligatoires"),e.emergencyContact?((!e.emergencyContact.name||e.emergencyContact.name.trim().length===0)&&t.push("Le nom du contact d'urgence est obligatoire"),(!e.emergencyContact.phone||e.emergencyContact.phone.trim().length===0)&&t.push("Le téléphone du contact d'urgence est obligatoire"),(!e.emergencyContact.relationship||e.emergencyContact.relationship.trim().length===0)&&t.push("La relation avec le contact d'urgence est obligatoire")):t.push("Le contact d'urgence est obligatoire"),e.renterExperience?(e.renterExperience.hasLicense===void 0&&t.push("L'information sur le permis nautique est obligatoire"),e.renterExperience.yearsOfExperience!==void 0&&e.renterExperience.yearsOfExperience<0&&t.push("Les années d'expérience ne peuvent pas être négatives")):t.push("Les informations sur l'expérience nautique sont obligatoires"),{isValid:t.length===0,errors:t}}calculateCancellationFees(e){const t=new Date,r=new Date(e.startDate),o=Math.ceil((r-t)/(1e3*60*60*24));let a=0;o<1?a=100:o<7?a=50:o<14?a=25:o<30&&(a=10);const s=e.pricing.totalAmount*a/100,n=e.pricing.totalAmount-s;return{daysUntilStart:o,feePercentage:a,cancellationFee:s,refundAmount:n,canCancel:o>=0}}formatBookingForDisplay(e){const t=new Date(e.startDate),r=new Date(e.endDate),o=Math.ceil((r-t)/(1e3*60*60*24));return{...e,formattedStartDate:t.toLocaleDateString("fr-FR",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),formattedEndDate:r.toLocaleDateString("fr-FR",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),formattedDuration:`${o} jour${o>1?"s":""}`,formattedTotalAmount:`${e.pricing.totalAmount}€`,formattedStatus:this.getStatusLabel(e.status),statusColor:this.getStatusColor(e.status),canCancel:this.canCancelBooking(e),canReview:this.canReviewBooking(e)}}getStatusLabel(e){return{pending:"En attente",confirmed:"Confirmée",paid:"Payée",active:"En cours",completed:"Terminée",cancelled:"Annulée",refunded:"Remboursée"}[e]||e}getStatusColor(e){return{pending:"status-warning",confirmed:"status-info",paid:"status-success",active:"status-primary",completed:"status-success",cancelled:"status-danger",refunded:"status-secondary"}[e]||"status-default"}canCancelBooking(e){const t=["pending","confirmed","paid"],r=new Date,o=new Date(e.startDate);return t.includes(e.status)&&o>r}canReviewBooking(e){var t;return e.status==="completed"&&!((t=e.review)!=null&&t.renterReview)}getAuthToken(){try{return localStorage.getItem("sailingloc_token")}catch(e){return console.error("Erreur lors de la récupération du token:",e),null}}createDefaultBookingData(e){const t=new Date;t.setDate(t.getDate()+1);const r=new Date;return r.setDate(r.getDate()+2),{boatId:e,startDate:t.toISOString().split("T")[0],endDate:r.toISOString().split("T")[0],participants:{adults:2,children:0},emergencyContact:{name:"",phone:"",relationship:""},renterExperience:{hasLicense:!1,licenseType:"",yearsOfExperience:0,previousBoatTypes:[],additionalInfo:""},specialRequests:"",skipperRequested:!1,additionalServices:[]}}toCalendarEvent(e){return{id:e._id,title:`${e.boat.name} - ${e.bookingNumber}`,start:e.startDate,end:e.endDate,color:this.getStatusColor(e.status),extendedProps:{booking:e,status:e.status,boatName:e.boat.name,totalAmount:e.pricing.totalAmount}}}}class q{constructor(){this.baseURL="https://sailingloc.onrender.com/api",this.paymentsEndpoint=`${this.baseURL}/payments`,this.stripePublishableKey=void 0,this.stripe=null,this.initializeStripe()}async initializeStripe(){if(this.stripePublishableKey&&window.Stripe)try{this.stripe=window.Stripe(this.stripePublishableKey),console.log("✅ Stripe initialisé")}catch(e){console.error("❌ Erreur lors de l'initialisation de Stripe:",e)}else console.log("ℹ️ Stripe non configuré - Mode simulation activé")}async createPaymentIntent(e){try{const t=this.getAuthToken();if(!t)throw new Error("Authentification requise");const r=await fetch(`${this.paymentsEndpoint}/create-payment-intent`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({bookingId:e})}),o=await r.json();if(!r.ok)throw new Error(o.message||"Erreur lors de la création du paiement");return o}catch(t){throw console.error("Erreur lors de la création du Payment Intent:",t),t}}async confirmPayment(e,t=null){try{if(!this.getAuthToken())throw new Error("Authentification requise");return this.stripe&&t?await this.confirmStripePayment(e,t):await this.confirmSimulatedPayment(e,t)}catch(r){throw console.error("Erreur lors de la confirmation du paiement:",r),r}}async confirmStripePayment(e,t){try{const{error:r,paymentIntent:o}=await this.stripe.confirmCardPayment(e,{payment_method:t});if(r)throw new Error(r.message);return o.status==="succeeded"?await this.notifyPaymentSuccess(e):{success:!1,message:"Le paiement n'a pas pu être traité"}}catch(r){throw console.error("Erreur lors du paiement Stripe:",r),r}}async confirmSimulatedPayment(e,t){try{const r=this.getAuthToken(),o=await fetch(`${this.paymentsEndpoint}/confirm-payment`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({paymentIntentId:e,paymentMethodId:t||"pm_simulation_card"})}),a=await o.json();if(!o.ok)throw new Error(a.message||"Erreur lors de la confirmation du paiement");return a}catch(r){throw console.error("Erreur lors du paiement simulé:",r),r}}async notifyPaymentSuccess(e){try{const t=this.getAuthToken(),r=await fetch(`${this.paymentsEndpoint}/confirm-payment`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({paymentIntentId:e})}),o=await r.json();if(!r.ok)throw new Error(o.message||"Erreur lors de la notification du paiement");return o}catch(t){throw console.error("Erreur lors de la notification du paiement:",t),t}}async refundPayment(e,t=null,r=""){try{const o=this.getAuthToken();if(!o)throw new Error("Authentification requise");const a=await fetch(`${this.paymentsEndpoint}/refund`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify({bookingId:e,amount:t,reason:r})}),s=await a.json();if(!a.ok)throw new Error(s.message||"Erreur lors du remboursement");return s}catch(o){throw console.error("Erreur lors du remboursement:",o),o}}async getPaymentHistory(e={}){try{const t=this.getAuthToken();if(!t)throw new Error("Authentification requise");const r=new URLSearchParams;Object.keys(e).forEach(n=>{e[n]!==void 0&&e[n]!==""&&r.append(n,e[n])});const o=`${this.paymentsEndpoint}/history?${r.toString()}`,a=await fetch(o,{method:"GET",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}}),s=await a.json();if(!a.ok)throw new Error(s.message||"Erreur lors de la récupération de l'historique");return s}catch(t){throw console.error("Erreur lors de la récupération de l'historique des paiements:",t),t}}async getPaymentStats(){try{const e=this.getAuthToken();if(!e)throw new Error("Authentification requise");const t=await fetch(`${this.paymentsEndpoint}/stats`,{method:"GET",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}}),r=await t.json();if(!t.ok)throw new Error(r.message||"Erreur lors de la récupération des statistiques");return r}catch(e){throw console.error("Erreur lors de la récupération des statistiques de paiement:",e),e}}createSimulatedPaymentForm(e,t){const r=document.createElement("form");return r.className="payment-form",r.innerHTML=`
      <div class="payment-header">
        <h3>Paiement sécurisé</h3>
        <p class="payment-amount">Montant: ${(e.amount/100).toFixed(2)}€</p>
      </div>
      
      <div class="payment-method">
        <h4>Mode de paiement</h4>
        <div class="payment-options">
          <label class="payment-option">
            <input type="radio" name="payment-method" value="card" checked>
            <span class="option-label">
              💳 Carte bancaire
            </span>
          </label>
        </div>
      </div>
      
      <div class="card-form" id="card-form">
        <div class="form-group">
          <label for="card-number">Numéro de carte</label>
          <input type="text" id="card-number" placeholder="1234 5678 9012 3456" maxlength="19" required>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="card-expiry">MM/AA</label>
            <input type="text" id="card-expiry" placeholder="12/25" maxlength="5" required>
          </div>
          <div class="form-group">
            <label for="card-cvc">CVC</label>
            <input type="text" id="card-cvc" placeholder="123" maxlength="4" required>
          </div>
        </div>
        
        <div class="form-group">
          <label for="card-name">Nom sur la carte</label>
          <input type="text" id="card-name" placeholder="Jean Dupont" required>
        </div>
      </div>
      
      <div class="payment-summary">
        <div class="summary-line">
          <span>Sous-total:</span>
          <span>${(e.amount/100).toFixed(2)}€</span>
        </div>
        <div class="summary-line total">
          <span>Total:</span>
          <span>${(e.amount/100).toFixed(2)}€</span>
        </div>
      </div>
      
      <button type="submit" class="btn-primary btn-full payment-submit">
        Payer ${(e.amount/100).toFixed(2)}€
      </button>
      
      <div class="payment-security">
        <p>🔒 Paiement sécurisé SSL</p>
      </div>
    `,this.setupCardFormatting(r),r.addEventListener("submit",async o=>{o.preventDefault();try{const a=r.querySelector(".payment-submit"),s=a.textContent;a.disabled=!0,a.textContent="Traitement...",await new Promise(i=>setTimeout(i,2e3));const n=await this.confirmPayment(e.id);if(n.success)this.showPaymentSuccess(t,n.data);else throw new Error(n.message||"Erreur de paiement")}catch(a){console.error("Erreur de paiement:",a),this.showPaymentError(t,a.message);const s=r.querySelector(".payment-submit");s.disabled=!1,s.textContent=originalText}}),t.innerHTML="",t.appendChild(r),{form:r,submit:()=>r.dispatchEvent(new Event("submit"))}}setupCardFormatting(e){const t=e.querySelector("#card-number"),r=e.querySelector("#card-expiry"),o=e.querySelector("#card-cvc");t&&t.addEventListener("input",a=>{var i;let s=a.target.value.replace(/\s/g,"").replace(/[^0-9]/gi,""),n=((i=s.match(/.{1,4}/g))==null?void 0:i.join(" "))||s;a.target.value=n}),r&&r.addEventListener("input",a=>{let s=a.target.value.replace(/\D/g,"");s.length>=2&&(s=s.substring(0,2)+"/"+s.substring(2,4)),a.target.value=s}),o&&o.addEventListener("input",a=>{a.target.value=a.target.value.replace(/[^0-9]/g,"")})}showPaymentSuccess(e,t){e.innerHTML=`
      <div class="payment-success">
        <div class="success-icon">✅</div>
        <h3>Paiement réussi !</h3>
        <p>Votre réservation a été confirmée.</p>
        <div class="payment-details">
          <p><strong>Numéro de réservation:</strong> ${t.booking.bookingNumber}</p>
          <p><strong>Montant payé:</strong> ${t.payment.amount}€</p>
        </div>
        <button class="btn-primary" onclick="window.location.reload()">
          Retour à l'accueil
        </button>
      </div>
    `}showPaymentError(e,t){const r=document.createElement("div");r.className="payment-error",r.innerHTML=`
      <div class="error-icon">❌</div>
      <p><strong>Erreur de paiement:</strong> ${t}</p>
      <button class="btn-secondary" onclick="this.parentElement.remove()">
        Réessayer
      </button>
    `,e.insertBefore(r,e.firstChild),setTimeout(()=>{r.parentElement&&r.remove()},5e3)}validateCardData(e){const t=[];if((!e.number||e.number.replace(/\s/g,"").length<13)&&t.push("Numéro de carte invalide"),!e.expiry||!/^\d{2}\/\d{2}$/.test(e.expiry))t.push("Date d'expiration invalide (MM/AA)");else{const[r,o]=e.expiry.split("/"),a=new Date,s=a.getFullYear()%100,n=a.getMonth()+1;(parseInt(r)<1||parseInt(r)>12)&&t.push("Mois d'expiration invalide"),(parseInt(o)<s||parseInt(o)===s&&parseInt(r)<n)&&t.push("Carte expirée")}return(!e.cvc||e.cvc.length<3||e.cvc.length>4)&&t.push("Code CVC inval ide"),(!e.name||e.name.trim().length<2)&&t.push("Nom sur la carte requis"),{isValid:t.length===0,errors:t}}getAuthToken(){try{return localStorage.getItem("sailingloc_token")}catch(e){return console.error("Erreur lors de la récupération du token:",e),null}}formatAmount(e,t="EUR"){return new Intl.NumberFormat("fr-FR",{style:"currency",currency:t}).format(e/100)}isStripeReady(){return this.stripe!==null&&this.stripePublishableKey!==void 0}async loadStripe(){if(window.Stripe)return!0;try{const e=document.createElement("script");return e.src="https://js.stripe.com/v3/",e.async=!0,new Promise((t,r)=>{e.onload=()=>{this.initializeStripe(),t(!0)},e.onerror=()=>r(!1),document.head.appendChild(e)})}catch(e){return console.error("Erreur lors du chargement de Stripe:",e),!1}}}class z{constructor(){this.notificationContainer=null,this.notificationQueue=[],this.maxNotifications=5,this.activeModals=new Set,this.loadingElements=new Map,this.init()}init(){this.createNotificationContainer(),this.setupGlobalEventListeners(),this.setupKeyboardShortcuts()}createNotificationContainer(){this.notificationContainer=document.getElementById("notifications"),this.notificationContainer||(this.notificationContainer=document.createElement("div"),this.notificationContainer.id="notifications",this.notificationContainer.className="notifications",document.body.appendChild(this.notificationContainer))}setupGlobalEventListeners(){document.addEventListener("keydown",e=>{e.key==="Escape"&&this.closeTopModal()}),window.addEventListener("resize",()=>{this.handleWindowResize()}),window.addEventListener("scroll",()=>{this.handleScroll()})}setupKeyboardShortcuts(){document.addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&e.key==="k"&&(e.preventDefault(),this.focusSearchInput())})}showNotification(e,t="info",r=5e3,o={}){const a={id:Date.now()+Math.random(),message:e,type:t,duration:r,...o};if(this.notificationContainer.children.length>=this.maxNotifications){this.notificationQueue.push(a);return}this.renderNotification(a)}renderNotification(e){const t=document.createElement("div");t.className=`notification notification-${e.type}`,t.setAttribute("data-notification-id",e.id);const r={success:"✅",error:"❌",warning:"⚠️",info:"ℹ️"};if(t.innerHTML=`
      <div class="notification-content">
        <span class="notification-icon">${r[e.type]||r.info}</span>
        <span class="notification-message">${e.message}</span>
        <button class="notification-close" aria-label="Fermer">×</button>
      </div>
      ${e.duration>0?'<div class="notification-progress"></div>':""}
    `,t.querySelector(".notification-close").addEventListener("click",()=>{this.hideNotification(e.id)}),t.style.transform="translateX(100%)",t.style.opacity="0",this.notificationContainer.appendChild(t),requestAnimationFrame(()=>{t.style.transform="translateX(0)",t.style.opacity="1"}),e.duration>0){const a=t.querySelector(".notification-progress");a&&(a.style.animationDuration=`${e.duration}ms`),setTimeout(()=>{this.hideNotification(e.id)},e.duration)}}hideNotification(e){const t=this.notificationContainer.querySelector(`[data-notification-id="${e}"]`);t&&(t.style.transform="translateX(100%)",t.style.opacity="0",setTimeout(()=>{if(t.parentElement&&(t.remove(),this.notificationQueue.length>0)){const r=this.notificationQueue.shift();this.renderNotification(r)}},300))}showModal(e,t={}){const r=document.getElementById(e);if(!r){console.error(`Modale ${e} non trouvée`);return}this.activeModals.add(e);const o={closeOnBackdrop:!0,focus:!0,...t};r.style.display="flex",r.classList.add("modal-active"),requestAnimationFrame(()=>{r.classList.add("modal-open")}),o.focus&&setTimeout(()=>{const a=r.querySelector("input, button, textarea, select");a&&a.focus()},100),document.body.classList.add("modal-open"),o.closeOnBackdrop&&r.addEventListener("click",this.handleModalBackdropClick.bind(this))}hideModal(e){const t=document.getElementById(e);t&&(this.activeModals.delete(e),t.classList.remove("modal-open"),setTimeout(()=>{t.style.display="none",t.classList.remove("modal-active"),this.activeModals.size===0&&document.body.classList.remove("modal-open")},300),t.removeEventListener("click",this.handleModalBackdropClick.bind(this)))}closeTopModal(){if(this.activeModals.size>0){const e=Array.from(this.activeModals).pop();this.hideModal(e)}}handleModalBackdropClick(e){if(e.target.classList.contains("modal")){const t=e.target.id;this.hideModal(t)}}showLoading(e,t="Chargement..."){const r=typeof e=="string"?document.getElementById(e)||document.querySelector(e):e;if(!r){console.error(`Élément ${e} non trouvé pour le loading`);return}this.loadingElements.has(r)||this.loadingElements.set(r,{originalContent:r.innerHTML,originalDisabled:r.disabled});const o=`
      <div class="loading-overlay">
        <div class="loading-spinner">
          <div class="spinner"></div>
          <span class="loading-message">${t}</span>
        </div>
      </div>
    `;r.tagName==="BUTTON"?(r.disabled=!0,r.innerHTML=`<span class="spinner-small"></span> ${t}`):(r.style.position="relative",r.insertAdjacentHTML("beforeend",o))}hideLoading(e){const t=typeof e=="string"?document.getElementById(e)||document.querySelector(e):e;if(!t)return;const r=this.loadingElements.get(t);r&&(t.innerHTML=r.originalContent,t.disabled=r.originalDisabled,this.loadingElements.delete(t));const o=t.querySelector(".loading-overlay");o&&o.remove()}scrollTo(e,t={}){const r=typeof e=="string"?document.querySelector(e):e;if(!r){console.error(`Élément ${e} non trouvé pour le scroll`);return}const o={behavior:"smooth",offset:0,...t},s=r.getBoundingClientRect().top+window.pageYOffset-o.offset;window.scrollTo({top:s,behavior:o.behavior})}handleWindowResize(){this.activeModals.forEach(e=>{document.getElementById(e)})}handleScroll(){const e=window.scrollY,t=document.querySelector(".hero");if(t){const o=t.querySelector(".hero-image");o&&(o.style.transform=`translateY(${e*.5}px)`)}const r=document.querySelector(".navbar");r&&(e>100?r.classList.add("scrolled"):r.classList.remove("scrolled"))}focusSearchInput(){const e=document.getElementById("search-location");e&&(e.focus(),e.select())}}const V=(()=>{let p={};const e={get(s){try{return localStorage.getItem(s)}catch{return null}},set(s,n){try{localStorage.setItem(s,n)}catch{}}},t=s=>p[s]??s,r=()=>{document.querySelectorAll("[data-i18n]").forEach(s=>{const n=s.getAttribute("data-i18n"),i=t(n);s.hasAttribute("data-i18n-placeholder")?s.placeholder=i.replace(/<[^>]+>/g,""):s.innerHTML=i})},o=async s=>{p=await(await fetch(`/i18n/${s}.json`,{cache:"no-cache"})).json(),e.set("lang",s),r()};return{init:async()=>{const s=e.get("lang")||(navigator.language||"fr").slice(0,2),n=["fr","en"].includes(s)?s:"fr";await o(n);const i=document.getElementById("langSwitcher");i&&(i.value=n,i.addEventListener("change",c=>o(c.target.value)))},load:o,t}})();class H{constructor(){this.prefix="sailingloc_",this.isStorageAvailable=this.checkStorageAvailability()}checkStorageAvailability(){try{const e="__storage_test__";return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch(e){return console.warn("localStorage non disponible:",e),!1}}setToken(e){if(!this.isStorageAvailable)return!1;try{return localStorage.setItem(`${this.prefix}token`,e),!0}catch(t){return console.error("Erreur lors de la sauvegarde du token:",t),!1}}getToken(){if(!this.isStorageAvailable)return null;try{return localStorage.getItem(`${this.prefix}token`)}catch(e){return console.error("Erreur lors de la récupération du token:",e),null}}removeToken(){if(!this.isStorageAvailable)return!1;try{return localStorage.removeItem(`${this.prefix}token`),!0}catch(e){return console.error("Erreur lors de la suppression du token:",e),!1}}setUser(e){if(!this.isStorageAvailable)return!1;try{return localStorage.setItem(`${this.prefix}user`,JSON.stringify(e)),!0}catch(t){return console.error("Erreur lors de la sauvegarde des données utilisateur:",t),!1}}getUser(){if(!this.isStorageAvailable)return null;try{const e=localStorage.getItem(`${this.prefix}user`);return e?JSON.parse(e):null}catch(e){return console.error("Erreur lors de la récupération des données utilisateur:",e),null}}removeUser(){if(!this.isStorageAvailable)return!1;try{return localStorage.removeItem(`${this.prefix}user`),!0}catch(e){return console.error("Erreur lors de la suppression des données utilisateur:",e),!1}}clearAuth(){const e=this.removeToken(),t=this.removeUser();return e&&t}setSearchPreferences(e){if(!this.isStorageAvailable)return!1;try{return localStorage.setItem(`${this.prefix}search_prefs`,JSON.stringify(e)),!0}catch(t){return console.error("Erreur lors de la sauvegarde des préférences:",t),!1}}getSearchPreferences(){if(!this.isStorageAvailable)return this.getDefaultSearchPreferences();try{const e=localStorage.getItem(`${this.prefix}search_prefs`);return e?JSON.parse(e):this.getDefaultSearchPreferences()}catch(e){return console.error("Erreur lors de la récupération des préférences:",e),this.getDefaultSearchPreferences()}}getDefaultSearchPreferences(){return{location:"",type:"all",maxPrice:1e3,minCapacity:1,sortBy:"price",sortOrder:"asc"}}addToSearchHistory(e){if(!this.isStorageAvailable||!e.trim())return!1;try{let t=this.getSearchHistory();return t=t.filter(r=>r.toLowerCase()!==e.toLowerCase()),t.unshift(e.trim()),t=t.slice(0,10),localStorage.setItem(`${this.prefix}search_history`,JSON.stringify(t)),!0}catch(t){return console.error("Erreur lors de la sauvegarde de l'historique:",t),!1}}getSearchHistory(){if(!this.isStorageAvailable)return[];try{const e=localStorage.getItem(`${this.prefix}search_history`);return e?JSON.parse(e):[]}catch(e){return console.error("Erreur lors de la récupération de l'historique:",e),[]}}clearSearchHistory(){if(!this.isStorageAvailable)return!1;try{return localStorage.removeItem(`${this.prefix}search_history`),!0}catch(e){return console.error("Erreur lors de l'effacement de l'historique:",e),!1}}addToFavorites(e){if(!this.isStorageAvailable||!e)return!1;try{let t=this.getFavorites();return t.includes(e)||(t.push(e),localStorage.setItem(`${this.prefix}favorites`,JSON.stringify(t))),!0}catch(t){return console.error("Erreur lors de l'ajout aux favoris:",t),!1}}removeFromFavorites(e){if(!this.isStorageAvailable||!e)return!1;try{let t=this.getFavorites();return t=t.filter(r=>r!==e),localStorage.setItem(`${this.prefix}favorites`,JSON.stringify(t)),!0}catch(t){return console.error("Erreur lors de la suppression des favoris:",t),!1}}getFavorites(){if(!this.isStorageAvailable)return[];try{const e=localStorage.getItem(`${this.prefix}favorites`);return e?JSON.parse(e):[]}catch(e){return console.error("Erreur lors de la récupération des favoris:",e),[]}}isFavorite(e){return this.getFavorites().includes(e)}setAppSettings(e){if(!this.isStorageAvailable)return!1;try{const r={...this.getAppSettings(),...e};return localStorage.setItem(`${this.prefix}app_settings`,JSON.stringify(r)),!0}catch(t){return console.error("Erreur lors de la sauvegarde des paramètres:",t),!1}}getAppSettings(){if(!this.isStorageAvailable)return this.getDefaultAppSettings();try{const e=localStorage.getItem(`${this.prefix}app_settings`);return e?JSON.parse(e):this.getDefaultAppSettings()}catch(e){return console.error("Erreur lors de la récupération des paramètres:",e),this.getDefaultAppSettings()}}getDefaultAppSettings(){return{theme:"light",language:"fr",currency:"EUR",notifications:!0,emailUpdates:!0,autoSave:!0}}setFormData(e,t){if(!this.isStorageAvailable||!e)return!1;try{return localStorage.setItem(`${this.prefix}form_${e}`,JSON.stringify(t)),!0}catch(r){return console.error("Erreur lors de la sauvegarde du formulaire:",r),!1}}getFormData(e){if(!this.isStorageAvailable||!e)return null;try{const t=localStorage.getItem(`${this.prefix}form_${e}`);return t?JSON.parse(t):null}catch(t){return console.error("Erreur lors de la récupération du formulaire:",t),null}}removeFormData(e){if(!this.isStorageAvailable||!e)return!1;try{return localStorage.removeItem(`${this.prefix}form_${e}`),!0}catch(t){return console.error("Erreur lors de la suppression du formulaire:",t),!1}}clearAllData(){if(!this.isStorageAvailable)return!1;try{return Object.keys(localStorage).forEach(t=>{t.startsWith(this.prefix)&&localStorage.removeItem(t)}),!0}catch(e){return console.error("Erreur lors du nettoyage des données:",e),!1}}getStorageSize(){if(!this.isStorageAvailable)return{bytes:0,kb:0,mb:0};try{let e=0;return Object.keys(localStorage).forEach(r=>{r.startsWith(this.prefix)&&(e+=localStorage.getItem(r).length)}),{bytes:e,kb:Math.round(e/1024*100)/100,mb:Math.round(e/(1024*1024)*100)/100}}catch(e){return console.error("Erreur lors du calcul de la taille:",e),{bytes:0,kb:0,mb:0}}}setWithExpiry(e,t,r){if(!this.isStorageAvailable)return!1;try{const a={value:t,expiry:new Date().getTime()+r};return localStorage.setItem(`${this.prefix}${e}`,JSON.stringify(a)),!0}catch(o){return console.error("Erreur lors de la sauvegarde avec expiration:",o),!1}}getWithExpiry(e){if(!this.isStorageAvailable)return null;try{const t=localStorage.getItem(`${this.prefix}${e}`);if(!t)return null;const r=JSON.parse(t);return new Date().getTime()>r.expiry?(localStorage.removeItem(`${this.prefix}${e}`),null):r.value}catch(t){return console.error("Erreur lors de la récupération avec expiration:",t),null}}setSessionData(e,t){try{return sessionStorage.setItem(`${this.prefix}${e}`,JSON.stringify(t)),!0}catch(r){return console.error("Erreur lors de la sauvegarde en session:",r),!1}}getSessionData(e){try{const t=sessionStorage.getItem(`${this.prefix}${e}`);return t?JSON.parse(t):null}catch(t){return console.error("Erreur lors de la récupération en session:",t),null}}removeSessionData(e){try{return sessionStorage.removeItem(`${this.prefix}${e}`),!0}catch(t){return console.error("Erreur lors de la suppression en session:",t),!1}}}class _{constructor(){this.authService=new R,this.boatService=new F,this.bookingService=new O,this.paymentService=new q,this.uiManager=new z,this.storageManager=new H,this.currentUser=null,this.currentPage=1,this.boatsPerPage=12,this.currentFilters={},this.selectedImages=[],this.isLoadingBoats=!1,this.currentBoats=[],this.init()}async init(){try{console.log("🚀 Initialisation de SailingLoc..."),await V.init(),await this.checkAuthStatus(),this.setupEventListeners();const e=window.location.pathname;(e==="/"||e.endsWith("index.html")||e.endsWith("boats.html"))&&await this.loadBoats(),this.setupNavigation(),this.initBoatManagement(),window.debugSailingLoc={testBoatCard:t=>{console.log("Test de création de carte de bateau:",t);const r=this.createBoatCard(t);return console.log("Résultat:",r),r},loadBoats:()=>this.loadBoats(),getCurrentBoats:()=>this.currentBoats||[]},console.log("✅ SailingLoc initialisé avec succès"),console.log("🔧 Fonctions de débogage disponibles: window.debugSailingLoc")}catch(e){console.error("❌ Erreur lors de l'initialisation:",e),this.uiManager.showNotification("Erreur lors du chargement de l'application","error")}}async checkAuthStatus(){const e=this.storageManager.getToken(),t=this.storageManager.getUser();if(console.log("🔐 [AUTH] Token trouvé:",e?"Oui":"Non"),console.log("🔐 [AUTH] User trouvé:",t?"Oui":"Non"),e&&t){this.currentUser=t,console.log("🔐 [AUTH] Utilisateur chargé depuis localStorage:",this.currentUser.email,"Rôle:",this.currentUser.role),this.updateUIForAuthenticatedUser();try{const r=await this.authService.verifyToken();console.log("🔐 [AUTH] Vérification token:",r.success?"Valide":"Invalide"),r.success&&r.data.user?(this.currentUser=r.data.user,this.storageManager.setUser(this.currentUser),console.log("🔐 [AUTH] Utilisateur mis à jour depuis le serveur")):(console.log("🔐 [AUTH] Token invalide, nettoyage..."),this.storageManager.clearAuth(),this.currentUser=null)}catch(r){console.error("Erreur lors de la vérification du token:",r),console.log("🔐 [AUTH] Erreur réseau, conservation de l'utilisateur localStorage")}}else console.log("🔐 [AUTH] Aucun token ou utilisateur trouvé, utilisateur non connecté"),this.currentUser=null}setupEventListeners(){this.setupAuthListeners(),this.setupSearchListeners(),this.setupNavigationListeners(),this.setupFormListeners(),this.setupModalListeners()}setupAuthListeners(){const e=document.getElementById("login-btn"),t=document.getElementById("register-btn");e&&e.addEventListener("click",()=>this.uiManager.showModal("login-modal")),t&&t.addEventListener("click",()=>this.uiManager.showModal("register-modal"));const r=document.getElementById("login-form"),o=document.getElementById("register-form");r&&r.addEventListener("submit",l=>this.handleLogin(l)),o&&o.addEventListener("submit",l=>this.handleRegister(l));const a=document.getElementById("switch-to-register"),s=document.getElementById("switch-to-login");a&&a.addEventListener("click",l=>{l.preventDefault(),this.uiManager.hideModal("login-modal"),this.uiManager.showModal("register-modal")}),s&&s.addEventListener("click",l=>{l.preventDefault(),this.uiManager.hideModal("register-modal"),this.uiManager.showModal("login-modal")});const n=document.getElementById("user-avatar"),i=document.getElementById("logout-link");n&&n.addEventListener("click",()=>this.toggleUserMenu()),i&&i.addEventListener("click",l=>{l.preventDefault(),this.handleLogout()});const c=document.getElementById("profile-link"),g=document.getElementById("bookings-link"),d=document.getElementById("boats-link");c&&c.addEventListener("click",l=>{l.preventDefault(),this.showProfile()}),g&&g.addEventListener("click",l=>{l.preventDefault(),this.showBookings()}),d&&d.addEventListener("click",l=>{l.preventDefault(),this.showMyBoats()})}setupSearchListeners(){const e=window.location.pathname;if(!(e==="/"||e.endsWith("index.html")||e.endsWith("boats.html")))return;const r=document.getElementById("search-btn");r&&r.addEventListener("click",()=>this.handleSearch());const o=document.getElementById("apply-filters");o&&o.addEventListener("click",()=>this.applyFilters());const a=document.getElementById("filter-price"),s=document.getElementById("price-display");a&&s&&a.addEventListener("input",c=>{s.textContent=`${c.target.value}€`});const n=document.getElementById("prev-page"),i=document.getElementById("next-page");n&&n.addEventListener("click",()=>this.changePage(this.currentPage-1)),i&&i.addEventListener("click",()=>this.changePage(this.currentPage+1))}setupNavigationListeners(){const e=document.getElementById("mobile-menu-toggle"),t=document.getElementById("nav-menu");e&&t&&e.addEventListener("click",()=>{t.classList.toggle("active"),e.classList.toggle("active")});const r=document.querySelectorAll(".nav-link");r.forEach(o=>{o.addEventListener("click",a=>{const s=o.getAttribute("href");if(s&&(s.includes(".html")||s.startsWith("http")))return;a.preventDefault();const n=s.substring(1),i=document.getElementById(n);i&&(i.scrollIntoView({behavior:"smooth",block:"start"}),r.forEach(c=>c.classList.remove("active")),o.classList.add("active"))})}),window.addEventListener("scroll",()=>{const o=document.getElementById("navbar");o&&(window.scrollY>100?o.classList.add("scrolled"):o.classList.remove("scrolled"))})}setupFormListeners(){const e=document.getElementById("contact-form");e&&e.addEventListener("submit",u=>this.handleContactForm(u));const t=document.getElementById("profile-form");t&&t.addEventListener("submit",u=>this.handleProfileUpdate(u));const r=document.getElementById("change-password-form");r&&r.addEventListener("submit",u=>this.handlePasswordChange(u));const o=document.getElementById("change-password-form-profile");o&&o.addEventListener("submit",u=>this.handlePasswordChange(u));const a=document.getElementById("preferences-form");a&&a.addEventListener("submit",u=>this.handlePreferencesUpdate(u));const s=document.getElementById("add-boat-form");s&&s.addEventListener("submit",u=>this.handleAddBoat(u));const n=document.getElementById("edit-boat-form");n&&n.addEventListener("submit",u=>this.handleEditBoat(u)),this.setupImageUpload();const i=document.getElementById("change-password-btn");i&&i.addEventListener("click",()=>{this.uiManager.showModal("change-password-modal")});const c=document.getElementById("add-boat-btn");c&&c.addEventListener("click",()=>{this.showAddBoatModal()}),document.querySelectorAll(".tab-btn").forEach(u=>{u.addEventListener("click",()=>{const y=u.getAttribute("data-tab");this.switchTab(y)})});const d=document.getElementById("refresh-bookings"),l=document.getElementById("refresh-boats");d&&d.addEventListener("click",()=>this.loadUserBookings()),l&&l.addEventListener("click",()=>this.loadOwnerBoats())}setupModalListeners(){document.querySelectorAll(".modal-close").forEach(r=>{r.addEventListener("click",o=>{const a=r.closest(".modal");a&&this.uiManager.hideModal(a.id)})}),document.querySelectorAll(".modal").forEach(r=>{r.addEventListener("click",o=>{o.target===r&&this.uiManager.hideModal(r.id)})})}async handleLogin(e){e.preventDefault();const t=document.getElementById("login-email").value,r=document.getElementById("login-password").value;if(console.log("🔐 Tentative de connexion:",{email:t,password:r?"***":"vide"}),!t||!r){this.uiManager.showNotification("Veuillez remplir tous les champs","error");return}try{this.uiManager.showLoading("login-form"),console.log("🔐 Appel AuthService.login...");const o=await this.authService.login(t,r);console.log("📡 Réponse complète:",o),o.success?(console.log("✅ Connexion réussie, données utilisateur:",o.data.user),this.currentUser=o.data.user,this.storageManager.setToken(o.data.token),this.storageManager.setUser(o.data.user),this.updateUIForAuthenticatedUser(),this.uiManager.hideModal("login-modal"),this.uiManager.showNotification("Connexion réussie !","success"),document.getElementById("login-form").reset()):(console.error("❌ Échec de connexion:",o.message),this.uiManager.showNotification(o.message||"Email ou mot de passe incorrect","error"))}catch(o){console.error("Erreur de connexion:",o),this.uiManager.showNotification(`Erreur de connexion: ${o.message||"Problème de réseau"}`,"error")}finally{this.uiManager.hideLoading("login-form")}}async handleRegister(e){e.preventDefault();const t={firstName:document.getElementById("register-firstname").value,lastName:document.getElementById("register-lastname").value,email:document.getElementById("register-email").value,password:document.getElementById("register-password").value,phone:document.getElementById("register-phone").value,role:document.getElementById("register-role").value};if(console.log("📝 Tentative d'inscription:",{...t,password:t.password?"***":"vide"}),!t.firstName||!t.lastName||!t.email||!t.password||!t.role){this.uiManager.showNotification("Veuillez remplir tous les champs obligatoires","error");return}if(t.password.length<6){this.uiManager.showNotification("Le mot de passe doit contenir au moins 6 caractères","error");return}try{this.uiManager.showLoading("register-form"),console.log("📝 Appel AuthService.register...");const r=await this.authService.register(t);console.log("📡 Réponse inscription:",r),r.success?(console.log("✅ Inscription réussie, données utilisateur:",r.data.user),this.currentUser=r.data.user,this.storageManager.setToken(r.data.token),this.storageManager.setUser(r.data.user),this.updateUIForAuthenticatedUser(),this.uiManager.hideModal("register-modal"),this.uiManager.showNotification("Inscription réussie !","success"),document.getElementById("register-form").reset()):(console.error("❌ Échec d'inscription:",r.message),this.uiManager.showNotification(r.message||"Erreur d'inscription","error"))}catch(r){console.error("Erreur d'inscription:",r),this.uiManager.showNotification(`Erreur d'inscription: ${r.message||"Problème de réseau"}`,"error")}finally{this.uiManager.hideLoading("register-form")}}async handleLogout(){try{await this.authService.logout(),this.currentUser=null,this.storageManager.clearAuth(),this.updateUIForUnauthenticatedUser(),this.uiManager.showNotification("Déconnexion réussie","success")}catch(e){console.error("Erreur de déconnexion:",e),this.currentUser=null,this.storageManager.clearAuth(),this.updateUIForUnauthenticatedUser()}}async showProfile(){try{this.uiManager.showModal("profile-modal"),await this.loadUserProfile()}catch(e){console.error("Erreur lors de l'affichage du profil:",e),this.uiManager.showNotification("Erreur lors du chargement du profil","error")}}async loadUserProfile(){var e,t;try{const r=await this.authService.getProfile();if(r.success){const o=r.data.user;document.getElementById("profile-firstname").value=o.firstName||"",document.getElementById("profile-lastname").value=o.lastName||"",document.getElementById("profile-email").value=o.email||"",document.getElementById("profile-phone").value=o.phone||"",o.address&&(document.getElementById("profile-street").value=o.address.street||"",document.getElementById("profile-city").value=o.address.city||"",document.getElementById("profile-postal").value=o.address.postalCode||""),o.preferences&&(document.getElementById("profile-language").value=o.preferences.language||"fr",document.getElementById("profile-currency").value=o.preferences.currency||"EUR",document.getElementById("email-notifications").checked=((e=o.preferences.notifications)==null?void 0:e.email)!==!1,document.getElementById("sms-notifications").checked=((t=o.preferences.notifications)==null?void 0:t.sms)===!0)}}catch(r){console.error("Erreur lors du chargement du profil:",r),this.uiManager.showNotification("Erreur lors du chargement du profil","error")}}async handleProfileUpdate(e){e.preventDefault();const t={firstName:document.getElementById("profile-firstname").value,lastName:document.getElementById("profile-lastname").value,phone:document.getElementById("profile-phone").value,address:{street:document.getElementById("profile-street").value,city:document.getElementById("profile-city").value,postalCode:document.getElementById("profile-postal").value}};try{this.uiManager.showLoading("profile-form");const r=await this.authService.updateProfile(t);r.success?(this.currentUser=r.data.user,this.storageManager.setUser(r.data.user),this.updateUIForAuthenticatedUser(),this.uiManager.showNotification("Profil mis à jour avec succès !","success")):this.uiManager.showNotification(r.message||"Erreur lors de la mise à jour","error")}catch(r){console.error("Erreur lors de la mise à jour du profil:",r),this.uiManager.showNotification("Erreur lors de la mise à jour du profil","error")}finally{this.uiManager.hideLoading("profile-form")}}async handlePasswordChange(e){e.preventDefault();const t=e.target,r=t.querySelector('[id*="current-password"]').value,o=t.querySelector('[id*="new-password"]').value,a=t.querySelector('[id*="confirm-password"]').value;if(o!==a){this.uiManager.showNotification("Les mots de passe ne correspondent pas","error");return}try{this.uiManager.showLoading(t);const s=await this.authService.changePassword(r,o);s.success?(this.uiManager.showNotification("Mot de passe modifié avec succès !","success"),t.reset()):this.uiManager.showNotification(s.message||"Erreur lors du changement de mot de passe","error")}catch(s){console.error("Erreur lors du changement de mot de passe:",s),this.uiManager.showNotification("Erreur lors du changement de mot de passe","error")}finally{this.uiManager.hideLoading(t)}}async handlePreferencesUpdate(e){e.preventDefault();const t={preferences:{language:document.getElementById("profile-language").value,currency:document.getElementById("profile-currency").value,notifications:{email:document.getElementById("email-notifications").checked,sms:document.getElementById("sms-notifications").checked}}};try{this.uiManager.showLoading("preferences-form");const r=await this.authService.updateProfile(t);r.success?(this.currentUser=r.data.user,this.storageManager.setUser(r.data.user),this.uiManager.showNotification("Préférences mises à jour avec succès !","success")):this.uiManager.showNotification(r.message||"Erreur lors de la mise à jour","error")}catch(r){console.error("Erreur lors de la mise à jour des préférences:",r),this.uiManager.showNotification("Erreur lors de la mise à jour des préférences","error")}finally{this.uiManager.hideLoading("preferences-form")}}async showBookings(){try{this.uiManager.showModal("bookings-modal"),await this.loadUserBookings()}catch(e){console.error("Erreur lors de l'affichage des réservations:",e),this.uiManager.showNotification("Erreur lors du chargement des réservations","error")}}async loadUserBookings(){try{const e=document.getElementById("bookings-list");e.innerHTML=`
        <div class="loading-spinner">
          <div class="spinner"></div>
          <p>Chargement des réservations...</p>
        </div>
      `;const t=await this.bookingService.getUserBookings();t.success?this.renderBookings(t.data.bookings):e.innerHTML=`
          <div class="no-results">
            <h3>Aucune réservation trouvée</h3>
            <p>Vous n'avez pas encore de réservations</p>
          </div>
        `}catch(e){console.error("Erreur lors du chargement des réservations:",e);const t=document.getElementById("bookings-list");t.innerHTML=`
        <div class="no-results">
          <h3>Erreur de chargement</h3>
          <p>Impossible de charger les réservations</p>
        </div>
      `}}renderBookings(e){const t=document.getElementById("bookings-list");if(e.length===0){t.innerHTML=`
        <div class="no-results">
          <h3>Aucune réservation</h3>
          <p>Vous n'avez pas encore de réservations</p>
        </div>
      `;return}t.innerHTML=e.map(r=>{var o,a,s;return`
      <div class="booking-card">
        <div class="booking-header">
          <span class="booking-number">#${r.bookingNumber}</span>
          <span class="booking-status status-${r.status}">${this.getStatusLabel(r.status)}</span>
        </div>
        <div class="booking-details">
          <div class="booking-detail">
            <span class="booking-detail-label">Bateau</span>
            <span class="booking-detail-value">${((o=r.boat)==null?void 0:o.name)||"N/A"}</span>
          </div>
          <div class="booking-detail">
            <span class="booking-detail-label">Dates</span>
            <span class="booking-detail-value">
              ${new Date(r.startDate).toLocaleDateString("fr-FR")} - 
              ${new Date(r.endDate).toLocaleDateString("fr-FR")}
            </span>
          </div>
          <div class="booking-detail">
            <span class="booking-detail-label">Montant</span>
            <span class="booking-detail-value">${((a=r.pricing)==null?void 0:a.totalAmount)||0}€</span>
          </div>
          <div class="booking-detail">
            <span class="booking-detail-label">Participants</span>
            <span class="booking-detail-value">${((s=r.participants)==null?void 0:s.total)||0} personnes</span>
          </div>
        </div>
        <div class="booking-actions">
          <button class="btn-secondary btn-small" onclick="app.viewBookingDetails('${r._id}')">
            Voir détails
          </button>
          ${r.status==="pending"||r.status==="confirmed"?`
            <button class="btn-ghost btn-small" onclick="app.cancelBooking('${r._id}')">
              Annuler
            </button>
          `:""}
        </div>
      </div>
    `}).join("")}async showMyBoats(){try{window.location.href="boat-management.html"}catch(e){console.error("Erreur lors de la redirection:",e),this.uiManager.showNotification("Erreur lors de la redirection","error")}}async loadOwnerBoats(){try{const e=document.getElementById("my-boats-list");e.innerHTML=`
        <div class="loading-spinner">
          <div class="spinner"></div>
          <p>Chargement de vos bateaux...</p>
        </div>
      `;const t=await this.boatService.getOwnerBoats();t.success?this.renderOwnerBoats(t.data.boats):e.innerHTML=`
          <div class="no-results">
            <h3>Aucun bateau trouvé</h3>
            <p>Vous n'avez pas encore ajouté de bateaux</p>
          </div>
        `}catch(e){console.error("Erreur lors du chargement des bateaux:",e);const t=document.getElementById("my-boats-list");t.innerHTML=`
        <div class="no-results">
          <h3>Erreur de chargement</h3>
          <p>Impossible de charger vos bateaux</p>
        </div>
      `}}renderOwnerBoats(e){const t=document.getElementById("my-boats-list");if(e.length===0){t.innerHTML=`
        <div class="no-results">
          <h3>Aucun bateau</h3>
          <p>Vous n'avez pas encore ajouté de bateaux</p>
          <button class="btn-primary" onclick="app.uiManager.showModal('add-boat-modal')">
            Ajouter votre premier bateau
          </button>
        </div>
      `;return}t.innerHTML=e.map(r=>{var o,a,s,n,i,c,g;return`
      <div class="my-boat-card">
        <div class="my-boat-image">
          <img src="${r.mainImage||((a=(o=r.images)==null?void 0:o[0])==null?void 0:a.url)||"https://images.pexels.com/photos/1001682/pexels-photo-1001682.jpeg?auto=compress&cs=tinysrgb&w=400&h=300&fit=crop"}" alt="${r.name}">
          <div class="boat-status-badge status-${r.status}">${this.getBoatStatusLabel(r.status)}</div>
        </div>
        <div class="my-boat-content">
          <h3 class="my-boat-name">${r.name}</h3>
          <p class="my-boat-location">📍 ${((s=r.location)==null?void 0:s.city)||"N/A"}</p>
          <div class="my-boat-stats">
            <div class="boat-stat">
              <div class="boat-stat-value">${((n=r.pricing)==null?void 0:n.dailyRate)||0}€</div>
              <div class="boat-stat-label">Prix/jour</div>
            </div>
            <div class="boat-stat">
              <div class="boat-stat-value">${((i=r.stats)==null?void 0:i.totalBookings)||0}</div>
              <div class="boat-stat-label">Réservations</div>
            </div>
            <div class="boat-stat">
              <div class="boat-stat-value">${((g=(c=r.rating)==null?void 0:c.average)==null?void 0:g.toFixed(1))||"0.0"}</div>
              <div class="boat-stat-label">Note</div>
            </div>
          </div>
          <div class="my-boat-actions">
            <button class="btn-primary btn-small" onclick="app.editBoat('${r._id}')">
              Modifier
            </button>
            <button class="btn-secondary btn-small" onclick="app.showBoatDetails('${r._id}')">
              Voir
            </button>
            <button class="btn-ghost btn-small" onclick="app.toggleBoatStatus('${r._id}')">
              ${r.status==="available"?"Désactiver":"Activer"}
            </button>
          </div>
        </div>
      </div>
    `}).join("")}switchTab(e){document.querySelectorAll(".tab-btn").forEach(t=>t.classList.remove("active")),document.querySelectorAll(".tab-content").forEach(t=>t.classList.remove("active")),document.querySelector(`[data-tab="${e}"]`).classList.add("active"),document.getElementById(e).classList.add("active")}getStatusLabel(e){return{pending:"En attente",confirmed:"Confirmée",paid:"Payée",active:"En cours",completed:"Terminée",cancelled:"Annulée",refunded:"Remboursée"}[e]||e}getBoatStatusLabel(e){return{available:"Disponible",rented:"Loué",maintenance:"Maintenance",inactive:"Inactif"}[e]||e}async viewBookingDetails(e){this.uiManager.showNotification("Fonctionnalité en cours de développement","info")}async cancelBooking(e){confirm("Êtes-vous sûr de vouloir annuler cette réservation ?")&&this.uiManager.showNotification("Fonctionnalité en cours de développement","info")}async toggleBoatStatus(e){this.uiManager.showNotification("Fonctionnalité en cours de développement","info")}updateUIForAuthenticatedUser(){const e=document.getElementById("login-btn"),t=document.getElementById("register-btn"),r=document.getElementById("user-menu"),o=document.getElementById("user-name"),a=document.getElementById("user-email"),s=document.getElementById("user-initials"),n=document.getElementById("boats-link");e&&(e.style.display="none"),t&&(t.style.display="none"),r&&(r.style.display="block"),this.currentUser&&(o&&(o.textContent=`${this.currentUser.firstName} ${this.currentUser.lastName}`),a&&(a.textContent=this.currentUser.email),s&&(s.textContent=`${this.currentUser.firstName[0]}${this.currentUser.lastName[0]}`.toUpperCase()),n&&["owner","admin"].includes(this.currentUser.role)&&(n.style.display="block"))}updateUIForUnauthenticatedUser(){const e=document.getElementById("login-btn"),t=document.getElementById("register-btn"),r=document.getElementById("user-menu");e&&(e.style.display="block"),t&&(t.style.display="block"),r&&(r.style.display="none")}toggleUserMenu(){const e=document.getElementById("user-dropdown");e&&e.classList.toggle("active")}async loadBoats(e={},t=1){if(this.isLoadingBoats){console.log("⏳ Chargement déjà en cours, annulation de la requête");return}this.isLoadingBoats=!0;try{const r=document.getElementById("boats-grid"),o=document.getElementById("boats-loading");o&&(o.style.display="block"),r&&(r.innerHTML="",console.log("🧹 Grille vidée avant le chargement"));const a={page:t,limit:this.boatsPerPage,...e};console.log("🚤 Chargement des bateaux depuis:",this.boatService.boatsEndpoint),console.log("📊 Paramètres:",a);const s=await this.boatService.getBoats(a);console.log("📡 Réponse API:",s),s.success?(this.currentBoats=s.data.boats,this.renderBoats(s.data.boats),this.renderPagination(s.data.pagination),this.currentPage=t,this.currentFilters=e):(console.error("❌ Erreur API:",s),this.uiManager.showNotification(`Erreur API: ${s.message||"Données non disponibles"}`,"error"),this.renderBoats([]))}catch(r){console.error("Erreur lors du chargement des bateaux:",r),this.uiManager.showNotification(`Erreur de connexion: ${r.message}`,"error"),this.renderBoats([])}finally{this.isLoadingBoats=!1;const r=document.getElementById("boats-loading");r&&(r.style.display="none")}}renderBoats(e=[]){const t=document.getElementById("boats-grid");if(!t){console.warn("⚠️ Grille de bateaux non trouvée");return}if(console.log(`🎨 Rendu de ${e.length} bateaux`),t.innerHTML="",e.length===0){t.innerHTML=`
        <div class="no-results">
          <h3>Aucun bateau trouvé</h3>
          <p>Essayez de modifier vos critères de recherche</p>
        </div>
      `,console.log("📭 Aucun bateau à afficher");return}const r=document.createDocumentFragment();let o=0,a=0;e.forEach((s,n)=>{try{console.log(`🔧 Création de la carte pour le bateau ${n+1}:`,s.name,s._id);const i=this.createBoatCard(s);if(i instanceof Element)r.appendChild(i),o++,console.log(`✅ Carte créée avec succès pour: ${s.name}`);else{console.warn("createBoatCard a renvoyé un type inattendu",i,s);const c=this.createErrorCard(`Erreur: ${s.name||"Bateau inconnu"}`);r.appendChild(c),a++}}catch(i){console.error("❌ Erreur lors de la création de la carte du bateau:",i,s);const c=this.createErrorCard(`Erreur: ${s.name||"Bateau inconnu"}`);r.appendChild(c),a++}}),t.appendChild(r),console.log(`🎉 Rendu terminé: ${o} cartes créées, ${a} erreurs`),console.log(`📊 Total d'éléments dans la grille: ${t.children.length}`)}createBoatCard(e){var a,s,n,i,c,g,d,l,u,y,w,b;const t=h=>(h??"").toString(),r=h=>t(h).slice(0,1).toUpperCase()+t(h).slice(1),o=h=>({EUR:"€",USD:"$",GBP:"£"})[h]||(h?` ${h}`:"");try{console.log("🔍 [DEBUG] Début de createBoatCard pour:",e.name,e._id);const h=e._id||e.id||"",E=t(e.name)||"Bateau",B=r(e.type||""),I=r(e.category||""),G=r(e.status||"Disponible"),N=t((a=e.location)==null?void 0:a.city)||"—",P=t((s=e.location)==null?void 0:s.marina)||"",S=t((n=e.location)==null?void 0:n.country)||"",T=((i=e.specifications)==null?void 0:i.length)??e.length??"—",k=((c=e.specifications)==null?void 0:c.width)??e.width??"—",$=(g=e.specifications)!=null&&g.fuelType?r(e.specifications.fuelType):"—",A=((d=e.capacity)==null?void 0:d.maxPeople)??((l=e.capacity)==null?void 0:l.people)??e.capacity??"—",M=((u=e.pricing)==null?void 0:u.dailyRate)??e.pricePerDay??null,L=((y=e.pricing)==null?void 0:y.securityDeposit)??e.deposit??null,x=((w=e.pricing)==null?void 0:w.currency)||"EUR";console.log("🖼️ [DEBUG] Images du bateau:",{imageUrls:e.imageUrls,images:e.images,boatId:e._id,boatName:e.name});let m="https://images.unsplash.com/photo-1508599589920-14cfa1c1fe4d?q=80&w=1200&auto=format&fit=crop";if(Array.isArray(e.images)&&e.images.length>0)typeof e.images[0]=="string"?(m=`https://sailingloc.onrender.com${e.images[0]}`,console.log("✅ Image trouvée dans images (string):",m)):(b=e.images[0])!=null&&b.url&&(m=`https://sailingloc.onrender.com${e.images[0].url}`,console.log("✅ Image trouvée dans images (object):",m));else if(Array.isArray(e.imageUrls)&&e.imageUrls.length>0){const v=e.imageUrls[0];v.fullUrl?m=v.fullUrl.replace("http://localhost:3000","https://sailingloc.onrender.com"):m=`https://sailingloc.onrender.com${v.url||v}`,console.log("✅ Image trouvée dans imageUrls:",m)}else e.imageUrl?(m=e.imageUrl.startsWith("http")?e.imageUrl:`https://sailingloc.onrender.com${e.imageUrl}`,console.log("✅ Image trouvée dans imageUrl:",m)):console.log("⚠️ Aucune image trouvée, utilisation de l'image par défaut");const U=M!=null?`<div class="boat-price">
             <span class="price">${t(M)}</span>
             <span class="price-unit">${o(x)}/jour</span>
           </div>`:"",j=L!=null?`<div class="price-details">Caution : ${t(L)}${o(x)}</div>`:"",D=[N,P].filter(Boolean).join(" • ")+(S?` (${S})`:""),f=document.createElement("article");f.className="boat-card",f.dataset.id=h,f.innerHTML=`
        <div class="boat-image">
          <img src="${m}" alt="${E}" loading="lazy" onerror="this.src='https://images.unsplash.com/photo-1508599589920-14cfa1c1fe4d?q=80&w=1200&auto=format&fit=crop'">
          ${I?`<span class="boat-badge">${I}</span>`:""}
          <div class="boat-rating">⭐ 4.8</div>
        </div>

        <div class="boat-content">
          <div class="boat-name">${E}</div>
          <div class="boat-location">${D}</div>

          <div class="boat-specs">
            ${B?`<span class="spec">${B}</span>`:""}
            ${A!=="—"?`<span class="spec">${A} pers.</span>`:""}
            ${T!=="—"?`<span class="spec">${T} m</span>`:""}
            ${k!=="—"?`<span class="spec">${k} m larg.</span>`:""}
            ${$!=="—"?`<span class="spec">${$}</span>`:""}
          </div>

          ${U}
          ${j}

          <button class="boat-details-btn" data-boat-id="${h}">Voir les détails</button>
        </div>
      `;const C=f.querySelector(".boat-details-btn");return C&&C.addEventListener("click",()=>this.showBoatDetails(h)),console.log("🎉 [DEBUG] Carte créée avec succès pour:",E),f}catch(h){return console.error("❌ [DEBUG] Erreur lors de la création de la carte de bateau:",h),console.error("❌ [DEBUG] Stack trace:",h.stack),console.error("❌ [DEBUG] Données du bateau:",e),this.createErrorCard("Erreur lors du chargement")}}createErrorCard(e){const t=document.createElement("div");return t.className="boat-card error-card",t.innerHTML=`
      <div class="boat-content">
        <h3>Erreur</h3>
        <p>${e}</p>
      </div>
    `,t}formatBoatType(e){return{voilier:"Voilier",catamaran:"Catamaran",yacht:"Yacht",bateau_moteur:"Bateau à moteur","bateau à moteur":"Bateau à moteur",semi_rigide:"Semi-rigide",peniche:"Péniche"}[e]||e}renderStars(e){const t=Math.floor(e),r=e%1>=.5,o=5-t-(r?1:0);let a="";for(let s=0;s<t;s++)a+="⭐";r&&(a+="⭐");for(let s=0;s<o;s++)a+="☆";return a}async showBoatDetails(e){window.location.href=`boat.html?id=${e}`}renderBoatDetails(e){var o,a,s,n,i,c,g;const t=document.getElementById("boat-modal-title"),r=document.getElementById("boat-details");t&&(t.textContent=e.name),r&&(r.innerHTML=`
        <div class="boat-details-content">
          <div class="boat-gallery">
            <div class="main-image">
              <img src="${e.mainImage||((a=(o=e.images)==null?void 0:o[0])==null?void 0:a.url)}" alt="${e.name}">
            </div>
            ${((s=e.images)==null?void 0:s.length)>1?`
              <div class="image-thumbnails">
                ${e.images.slice(1,5).map(d=>`
                  <img src="${d.url}" alt="${d.caption||e.name}" class="thumbnail">
                `).join("")}
              </div>
            `:""}
          </div>
          
          <div class="boat-info">
            <div class="boat-header">
              <div class="boat-meta">
                <span class="boat-type">${this.formatBoatType(e.type)}</span>
                <span class="boat-category">${e.category}</span>
              </div>
              <div class="boat-rating-large">
                ${this.renderStars(((n=e.rating)==null?void 0:n.average)||0)}
                <span class="rating-text">${((c=(i=e.rating)==null?void 0:i.average)==null?void 0:c.toFixed(1))||"0.0"} (${((g=e.rating)==null?void 0:g.totalReviews)||0} avis)</span>
              </div>
            </div>
            
            <p class="boat-description">${e.description}</p>
            
            <div class="boat-specs-grid">
              <div class="spec-item">
                <strong>Capacité:</strong> ${e.capacity.maxPeople} personnes
              </div>
              <div class="spec-item">
                <strong>Longueur:</strong> ${e.specifications.length}m
              </div>
              <div class="spec-item">
                <strong>Largeur:</strong> ${e.specifications.width}m
              </div>
              ${e.capacity.cabins?`
                <div class="spec-item">
                  <strong>Cabines:</strong> ${e.capacity.cabins}
                </div>
              `:""}
              ${e.capacity.berths?`
                <div class="spec-item">
                  <strong>Couchages:</strong> ${e.capacity.berths}
                </div>
              `:""}
              ${e.capacity.bathrooms?`
                <div class="spec-item">
                  <strong>Salles de bain:</strong> ${e.capacity.bathrooms}
                </div>
              `:""}
            </div>
            
            <div class="boat-location-info">
              <h3>Localisation</h3>
              <p>📍 ${e.location.marina}, ${e.location.city}, ${e.location.country}</p>
            </div>
            
            <div class="boat-pricing">
              <div class="price-main">
                <span class="price-amount">${e.pricing.dailyRate}€</span>
                <span class="price-unit">/jour</span>
              </div>
              ${e.pricing.weeklyRate?`
                <div class="price-secondary">
                  <span class="price-amount">${e.pricing.weeklyRate}€</span>
                  <span class="price-unit">/semaine</span>
                </div>
              `:""}
              <div class="price-details">
                <p>Caution: ${e.pricing.securityDeposit}€</p>
                ${e.pricing.cleaningFee>0?`<p>Frais de nettoyage: ${e.pricing.cleaningFee}€</p>`:""}
              </div>
            </div>
            
            <div class="boat-actions">
              ${this.currentUser?`
                <button class="btn-primary btn-large" onclick="app.initiateBooking('${e._id}')">
                  Réserver maintenant
                </button>
              `:`
                <button class="btn-primary btn-large" onclick="app.uiManager.showModal('login-modal')">
                  Connectez-vous pour réserver
                </button>
              `}
            </div>
          </div>
        </div>
      `)}renderPagination(e){const t=document.getElementById("boats-pagination"),r=document.getElementById("page-numbers"),o=document.getElementById("prev-page"),a=document.getElementById("next-page");if(!t||!r)return;if(e.pages<=1){t.style.display="none";return}t.style.display="flex",o&&(o.disabled=e.page<=1),a&&(a.disabled=e.page>=e.pages),r.innerHTML="";const s=Math.max(1,e.page-2),n=Math.min(e.pages,e.page+2);for(let i=s;i<=n;i++){const c=document.createElement("button");c.className=`btn-page ${i===e.page?"active":""}`,c.textContent=i,c.addEventListener("click",()=>this.changePage(i)),r.appendChild(c)}}async changePage(e){if(e<1)return;await this.loadBoats(this.currentFilters,e);const t=document.getElementById("boats");t&&t.scrollIntoView({behavior:"smooth"})}async handleSearch(){const e=document.getElementById("search-location").value;document.getElementById("search-start-date").value,document.getElementById("search-end-date").value;const t=document.getElementById("search-guests").value,r={};e&&(r.search=e),t&&(r.minCapacity=t);const o=document.getElementById("boats");o&&o.scrollIntoView({behavior:"smooth"}),await this.loadBoats(r,1)}async applyFilters(){const e={},t=document.getElementById("filter-type").value,r=document.getElementById("filter-price").value,o=document.getElementById("filter-capacity").value;t&&(e.type=t),r&&(e.maxPrice=r),o&&(e.minCapacity=o),await this.loadBoats(e,1)}async handleContactForm(e){e.preventDefault();const t=document.getElementById("contact-name").value,r=document.getElementById("contact-email").value,o=document.getElementById("contact-message").value;try{this.uiManager.showLoading("contact-form");const a=await fetch(`${this.apiBaseUrl||""}/api/contact`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t,email:r,message:o})}),s=await a.json();if(!a.ok||!s.success)throw new Error(s.message||"Échec de l'envoi du message");this.uiManager.showNotification("Message envoyé avec succès !","success"),document.getElementById("contact-form").reset()}catch(a){console.error("Erreur lors de l'envoi du message:",a),this.uiManager.showNotification("Erreur lors de l'envoi du message","error")}finally{this.uiManager.hideLoading("contact-form")}}setupNavigation(){const e=document.querySelectorAll("section[id]"),t=document.querySelectorAll(".nav-link");if(e.length>0&&window.location.pathname==="/"||window.location.pathname.endsWith("index.html")){const r=new IntersectionObserver(o=>{o.forEach(a=>{if(a.isIntersecting){const s=a.target.getAttribute("id");t.forEach(n=>{n.classList.remove("active"),n.getAttribute("href")===`#${s}`&&n.classList.add("active")})}})},{threshold:.3,rootMargin:"-100px 0px -100px 0px"});e.forEach(o=>r.observe(o))}}setupImageUpload(){const e=document.getElementById("boat-image-input"),t=document.getElementById("image-preview-container");e&&t&&e.addEventListener("change",s=>{this.handleImageSelection(s.target.files,"add")});const r=document.getElementById("edit-boat-images"),o=document.getElementById("edit-image-preview-container");r&&o&&r.addEventListener("change",s=>{this.handleImageSelection(s.target.files,"edit")});const a=document.getElementById("edit-image-upload-area");a&&a.addEventListener("click",()=>{r.click()})}handleImageSelection(e,t="add"){const o=["image/jpeg","image/jpg","image/png","image/webp"];Array.from(e).forEach(a=>{if(a.size>5242880){this.uiManager.showNotification(`L'image ${a.name} est trop volumineuse (max 5MB)`,"error");return}if(!o.includes(a.type)){this.uiManager.showNotification(`Format non supporté pour ${a.name}`,"error");return}t==="add"?(this.selectedImages.push(a),this.addImagePreview(a)):t==="edit"&&this.addEditImagePreview(a)})}addImagePreview(e){const t=document.getElementById("image-preview-container"),r=new FileReader;r.onload=o=>{const a=document.createElement("div");a.className="image-preview",a.innerHTML=`
        <img src="${o.target.result}" alt="Aperçu">
        <button type="button" class="remove-image" onclick="app.removeImage('${e.name}')">×</button>
      `,t.appendChild(a)},r.readAsDataURL(e)}addEditImagePreview(e){const t=document.getElementById("edit-image-preview-container"),r=new FileReader;r.onload=o=>{const a=document.createElement("div");a.className="image-preview-item new",a.innerHTML=`
        <img src="${o.target.result}" alt="Aperçu">
        <button type="button" class="remove-image-btn" onclick="app.removeEditImage('${e.name}')">×</button>
      `,t.appendChild(a)},r.readAsDataURL(e)}removeImage(e){this.selectedImages=this.selectedImages.filter(t=>t.name!==e),this.updateImagePreviews()}removeEditImage(e){document.getElementById("edit-image-preview-container").querySelectorAll(".image-preview-item.new").forEach(o=>{const a=o.querySelector("img");a&&a.src.includes(e)&&o.remove()})}removeExistingImage(e){const r=document.getElementById("edit-image-preview-container").querySelectorAll(".image-preview-item.existing");r[e]&&r[e].remove()}updateImagePreviews(){const e=document.getElementById("image-preview-container");e&&(e.innerHTML="",this.selectedImageFiles&&this.selectedImageFiles.length>0&&this.displayImagePreviews(this.selectedImageFiles))}async handleAddBoat(e){var c,g;if(e.preventDefault(),!this.currentUser){this.uiManager.showNotification("Vous devez être connecté pour ajouter un bateau","error");return}const t=new FormData;t.append("name",document.getElementById("boat-name").value.trim()),t.append("type",document.getElementById("boat-type").value),t.append("description",document.getElementById("boat-description").value.trim()),t.append("category",document.getElementById("boat-category").value);const r=parseFloat(document.getElementById("boat-length").value),o=parseFloat(document.getElementById("boat-width").value);t.append("specifications[length]",isNaN(r)?"":r),t.append("specifications[width]",isNaN(o)?"":o);const a=parseInt(document.getElementById("boat-capacity").value,10);t.append("capacity[maxPeople]",isNaN(a)?"":a),t.append("location[city]",document.getElementById("boat-city").value.trim()),t.append("location[marina]",document.getElementById("boat-marina").value.trim()),t.append("location[country]","France");const s=parseFloat(document.getElementById("boat-daily-rate").value),n=parseFloat(document.getElementById("boat-security-deposit").value);t.append("pricing[dailyRate]",isNaN(s)?"":s),t.append("pricing[securityDeposit]",isNaN(n)?"":n),this.selectedImageFiles&&this.selectedImageFiles.length>0?(console.log("📸 Upload de",this.selectedImageFiles.length,"image(s):"),this.selectedImageFiles.forEach((d,l)=>{console.log(`  Image ${l+1}:`,d.name,d.type,d.size,"bytes"),t.append("images",d)})):console.log("⚠️ Aucune image sélectionnée pour l'upload");const i={"boat-name":"Nom du bateau","boat-type":"Type de bateau","boat-category":"Catégorie","boat-capacity":"Capacité","boat-daily-rate":"Tarif journalier"};for(const[d,l]of Object.entries(i)){const u=document.getElementById(d);if(!u||!u.value.trim()){this.uiManager.showNotification(`${l} est requis`,"error");return}}if(isNaN(a)||a<=0){this.uiManager.showNotification("La capacité doit être un nombre positif","error");return}if(isNaN(s)||s<=0){this.uiManager.showNotification("Le tarif journalier doit être un nombre positif","error");return}console.log("📋 Données du bateau à envoyer:");for(const[d,l]of t.entries())console.log(`${d}: ${l}`);try{this.uiManager.showLoading("add-boat-form");const d=await fetch(`${this.boatService.boatsEndpoint}`,{method:"POST",headers:{Authorization:`Bearer ${this.boatService.getAuthToken()}`},body:t}),l=await d.json();if(console.log("📡 Réponse de l'API:",{status:d.status,ok:d.ok,data:l}),d.ok&&l.success)console.log("✅ Bateau créé avec succès:",l.data),console.log("🖼️ Images du bateau créé:",((c=l.data)==null?void 0:c.images)||((g=l.data)==null?void 0:g.imageUrls)),this.uiManager.showNotification("Bateau ajouté avec succès !","success"),this.uiManager.hideModal("add-boat-modal"),document.getElementById("add-boat-form").reset(),this.selectedImageFiles=[],this.updateImagePreviews(),document.getElementById("my-boats-modal").classList.contains("active")&&await this.loadOwnerBoats(),window.location.pathname.includes("boat-management.html")&&(console.log("🔄 Rechargement de la page de gestion des bateaux..."),await this.loadBoats());else throw new Error(l.message||"Erreur lors de l'ajout du bateau")}catch(d){console.error("Erreur lors de l'ajout du bateau:",d),this.uiManager.showNotification(`Erreur: ${d.message}`,"error")}finally{this.uiManager.hideLoading("add-boat-form")}}async handleEditBoat(e){if(e.preventDefault(),!this.currentUser){this.uiManager.showNotification("Vous devez être connecté pour modifier un bateau","error");return}const t=e.target,r=t.dataset.boatId;if(!r){this.uiManager.showNotification("ID du bateau manquant","error");return}const o=new FormData(t),a=["name","type","category","length","width","capacity","city","pricePerDay","deposit"];for(const s of a)if(!o.get(s)){this.uiManager.showNotification(`Le champ ${s} est requis`,"error");return}try{this.uiManager.showLoading("edit-boat-form");const s=await fetch(`${this.boatService.boatsEndpoint}/${r}`,{method:"PUT",headers:{Authorization:`Bearer ${this.currentUser.token}`},body:o}),n=await s.json();if(s.ok&&n.success)this.uiManager.showNotification("Bateau modifié avec succès !","success"),this.uiManager.hideModal("edit-boat-modal"),t.reset(),this.selectedImages=[],this.updateImagePreviews(),await this.loadBoatManagementData();else throw new Error(n.message||"Erreur lors de la modification du bateau")}catch(s){console.error("Erreur lors de la modification du bateau:",s),this.uiManager.showNotification(`Erreur: ${s.message}`,"error")}finally{this.uiManager.hideLoading("edit-boat-form")}}async initiateBooking(e){if(!this.currentUser){this.uiManager.showModal("login-modal");return}this.uiManager.showNotification("Fonctionnalité de réservation en cours de développement","info")}initBoatManagement(){console.log("🚤 Initialisation de la gestion des bateaux..."),window.location.pathname.includes("boat-management.html")&&(this.setupBoatManagementEventListeners(),setTimeout(()=>{this.loadBoatManagementData()},100))}setupBoatManagementEventListeners(){const e=document.getElementById("status-filter"),t=document.getElementById("type-filter"),r=document.getElementById("search-input"),o=document.getElementById("search-btn");e&&e.addEventListener("change",()=>this.filterBoats()),t&&t.addEventListener("change",()=>this.filterBoats()),r&&r.addEventListener("input",()=>this.debounceSearch()),o&&o.addEventListener("click",()=>this.filterBoats());const a=document.getElementById("grid-view-btn"),s=document.getElementById("list-view-btn");a&&a.addEventListener("click",()=>this.setViewMode("grid")),s&&s.addEventListener("click",()=>this.setViewMode("list"));const n=document.getElementById("prev-page-btn"),i=document.getElementById("next-page-btn");n&&n.addEventListener("click",()=>this.changePage(-1)),i&&i.addEventListener("click",()=>this.changePage(1));const c=document.getElementById("retry-btn");c&&c.addEventListener("click",()=>this.loadBoatManagementData());const g=document.getElementById("add-first-boat-btn");g&&g.addEventListener("click",()=>{this.uiManager.showModal("add-boat-modal")}),this.setupBoatCardActionListeners(),this.setupImageUploadListeners()}setupBoatCardActionListeners(){console.log("🔧 Configuration des event listeners pour les boutons d'action"),document.addEventListener("click",e=>{var r;console.log("🖱️ Clic détecté sur:",e.target);const t=e.target.closest(".boat-action-btn");if(t){const o=t.getAttribute("data-boat-id");if(!o){console.log("❌ Pas d'ID de bateau");return}console.log("✅ Bouton d'action cliqué:",t.className,"pour bateau:",o),e.preventDefault(),e.stopPropagation();try{t.classList.contains("edit-btn")?(console.log("🔄 Appel de editBoat..."),this.editBoat(o)):t.classList.contains("images-btn")?(console.log("🖼️ Appel de manageImages..."),this.manageImages(o)):t.classList.contains("delete-btn")?(console.log("🗑️ Appel de deleteBoat..."),this.deleteBoat(o)):t.classList.contains("restore-btn")?(console.log("🔄 Appel de restoreBoat..."),this.restoreBoat(o)):console.log("❌ Type de bouton non reconnu:",t.className)}catch(a){console.error("❌ Erreur lors de l'appel de la méthode:",a),(r=this.uiManager)==null||r.showNotification("Erreur lors de l'exécution de l'action","error")}return}if(e.target.id==="select-images-btn"){if(console.log("📷 Bouton de sélection d'images cliqué"),e.preventDefault(),e.stopPropagation(),e.target.disabled)return;e.target.disabled=!0,setTimeout(()=>{e.target.disabled=!1},1e3);const o=document.getElementById("boat-image-input");o?o.click():console.error("❌ Input file non trouvé");return}if(e.target.id==="add-images-btn"){console.log("📷 Bouton d'ajout d'images cliqué"),e.preventDefault(),e.stopPropagation();const o=document.getElementById("image-upload");o?o.click():console.error("❌ Input file non trouvé");return}console.log("❌ Pas un bouton d'action reconnu")}),console.log("✅ Event listeners configurés")}setupImageUploadListeners(){console.log("📷 Configuration des event listeners pour l'upload d'images"),document.addEventListener("change",e=>{e.target.id==="boat-image-input"?(console.log("📁 Fichiers sélectionnés dans l'input principal"),this.handleImageSelection(e.target.files)):e.target.id==="image-upload"&&(console.log("📁 Fichiers sélectionnés dans la modale d'images"),e.target.onchange&&e.target.onchange(e))}),console.log("✅ Event listeners d'upload configurés")}handleImageSelection(e){var o;if(console.log("🖼️ Gestion de la sélection d'images:",e.length,"fichier(s)"),e.length===0){console.log("❌ Aucun fichier sélectionné");return}const t=["image/jpeg","image/jpg","image/png","image/webp"],r=Array.from(e).filter(a=>t.includes(a.type)?a.size>5*1024*1024?(console.warn("⚠️ Fichier ignoré (trop volumineux):",a.name,a.size),!1):!0:(console.warn("⚠️ Fichier ignoré (type non supporté):",a.name,a.type),!1));if(r.length===0){(o=this.uiManager)==null||o.showNotification("Aucun fichier valide sélectionné","warning");return}console.log("✅",r.length,"fichier(s) valide(s) sélectionné(s)"),this.displayImagePreviews(r),this.selectedImageFiles=r}displayImagePreviews(e){const t=document.getElementById("image-preview-container");if(!t){console.error("❌ Container d'aperçus non trouvé");return}t.innerHTML="",e.forEach((r,o)=>{const a=new FileReader;a.onload=s=>{const n=document.createElement("div");n.className="image-preview-item",n.innerHTML=`
          <img src="${s.target.result}" alt="Aperçu ${o+1}">
          <div class="image-preview-info">
            <span class="image-name">${r.name}</span>
            <span class="image-size">${(r.size/1024/1024).toFixed(2)} MB</span>
          </div>
          <button type="button" class="remove-image-btn" data-index="${o}">×</button>
        `,t.appendChild(n)},a.readAsDataURL(r)}),t.addEventListener("click",r=>{if(r.target.classList.contains("remove-image-btn")){const o=parseInt(r.target.getAttribute("data-index"));this.removeImagePreview(o)}})}removeImagePreview(e){console.log("🗑️ Suppression de l'aperçu",e),this.selectedImageFiles&&this.selectedImageFiles[e]&&(this.selectedImageFiles.splice(e,1),this.displayImagePreviews(this.selectedImageFiles))}async loadBoatManagementData(){try{if(this.showLoadingState(),console.log("🚤 [BOAT MANAGEMENT] Chargement des données de gestion des bateaux"),!this.currentUser){console.log("🔄 [BOAT MANAGEMENT] Utilisateur non trouvé, tentative de rechargement...");const o=this.storageManager.getUser();if(o)this.currentUser=o,console.log("✅ [BOAT MANAGEMENT] Utilisateur rechargé depuis le localStorage");else throw new Error("Vous devez être connecté pour accéder à la gestion des bateaux")}const e=this.storageManager.getToken();if(!e)throw new Error("Token d'authentification manquant. Veuillez vous reconnecter.");console.log("🔐 [BOAT MANAGEMENT] Utilisateur connecté:",this.currentUser.email),console.log("🔐 [BOAT MANAGEMENT] Token présent:",e?"Oui":"Non");const[t,r]=await Promise.all([this.boatService.getBoatStats(),this.boatService.getOwnerBoats()]);t.success&&this.updateStats(t.data.overview),r.success&&(this.displayBoats(r.data.boats),this.updatePagination(r.data.pagination)),this.hideLoadingState(),console.log("✅ [BOAT MANAGEMENT] Données chargées avec succès")}catch(e){console.error("❌ [BOAT MANAGEMENT] Erreur lors du chargement des données:",e),e.message.includes("Vous devez être connecté")||e.message.includes("Authentification requise")||e.message.includes("Token")?(this.showErrorState("Vous devez être connecté pour accéder à cette page. Redirection vers la page de connexion..."),setTimeout(()=>{window.location.href="index.html"},3e3)):this.showErrorState(e.message)}}showLoadingState(){const e=document.getElementById("loading-message"),t=document.getElementById("error-message"),r=document.getElementById("empty-message"),o=document.getElementById("boats-grid");e&&(e.style.display="block"),t&&(t.style.display="none"),r&&(r.style.display="none"),o&&(o.style.display="none")}hideLoadingState(){const e=document.getElementById("loading-message");e&&(e.style.display="none")}showErrorState(e){const t=document.getElementById("loading-message"),r=document.getElementById("error-message"),o=document.getElementById("error-text"),a=document.getElementById("empty-message"),s=document.getElementById("boats-grid");t&&(t.style.display="none"),r&&(r.style.display="block"),o&&(o.textContent=e),a&&(a.style.display="none"),s&&(s.style.display="none")}updateStats(e){const t=document.getElementById("total-boats"),r=document.getElementById("available-boats"),o=document.getElementById("total-bookings"),a=document.getElementById("total-revenue");t&&(t.textContent=e.totalBoats||0),r&&(r.textContent=e.availableBoats||0),o&&(o.textContent=e.totalBookings||0),a&&(a.textContent=`${e.totalRevenue||0}€`)}displayBoats(e){const t=document.getElementById("boats-grid"),r=document.getElementById("empty-message"),o=document.getElementById("error-message");if(t){if(e.length===0){t.style.display="none",r&&(r.style.display="block"),o&&(o.style.display="none");return}t.style.display="grid",r&&(r.style.display="none"),o&&(o.style.display="none"),t.innerHTML=e.map(a=>this.createBoatManagementCard(a)).join("")}}createBoatManagementCard(e){var s,n,i,c,g;const t=e.status||"available",r=this.getStatusText(e.status),o=this.getTypeText(e.type);console.log("🖼️ [DEBUG] Images du bateau (gestion):",{imageUrls:e.imageUrls,images:e.images,boatId:e._id,boatName:e.name});let a="boat-icon.svg";if(Array.isArray(e.images)&&e.images.length>0)typeof e.images[0]=="string"?(a=`https://sailingloc.onrender.com${e.images[0]}`,console.log("✅ Image de gestion trouvée dans images (string):",a)):(s=e.images[0])!=null&&s.url&&(a=`https://sailingloc.onrender.com${e.images[0].url}`,console.log("✅ Image de gestion trouvée dans images (object):",a));else if(Array.isArray(e.imageUrls)&&e.imageUrls.length>0){const d=e.imageUrls[0];d.fullUrl?a=d.fullUrl.replace("http://localhost:3000","https://sailingloc.onrender.com"):a=`https://sailingloc.onrender.com${d.url||d}`,console.log("✅ Image de gestion trouvée dans imageUrls:",a)}else e.imageUrl?(a=e.imageUrl.startsWith("http")?e.imageUrl:`https://sailingloc.onrender.com${e.imageUrl}`,console.log("✅ Image de gestion trouvée dans imageUrl:",a)):console.log("⚠️ Aucune image trouvée pour la gestion, utilisation de l'icône par défaut");return`
      <div class="boat-management-card ${e.isActive?"":"inactive"}" data-boat-id="${e._id}">
        <img src="${a}" alt="${e.name}" class="boat-card-image" onerror="this.src='boat-icon.svg'">
        <div class="boat-card-content">
          <div class="boat-card-header">
            <div>
              <h3 class="boat-card-title">${e.name}</h3>
              <span class="boat-card-type">${o}</span>
            </div>
            <span class="boat-card-status ${t}">${r}</span>
          </div>
          
          <div class="boat-card-info">
            <div class="boat-info-item">
              <span class="boat-info-icon">👥</span>
              <span>${((n=e.capacity)==null?void 0:n.maxPeople)||0} personnes</span>
            </div>
            <div class="boat-info-item">
              <span class="boat-info-icon">📏</span>
              <span>${((i=e.specifications)==null?void 0:i.length)||0}m</span>
            </div>
            <div class="boat-info-item">
              <span class="boat-info-icon">💰</span>
              <span>${((c=e.pricing)==null?void 0:c.dailyRate)||0}€/jour</span>
            </div>
            <div class="boat-info-item">
              <span class="boat-info-icon">📍</span>
              <span>${((g=e.location)==null?void 0:g.city)||"N/A"}</span>
            </div>
          </div>
          
          <div class="boat-card-actions">
            <button class="boat-action-btn edit-btn" data-boat-id="${e._id}">
              <span>✏️</span>
              Modifier
            </button>
            <button class="boat-action-btn images-btn" data-boat-id="${e._id}">
              <span>🖼️</span>
              Images
            </button>
            ${e.isActive?`<button class="boat-action-btn danger delete-btn" data-boat-id="${e._id}">
                <span>🗑️</span>
                Supprimer
              </button>`:`<button class="boat-action-btn primary restore-btn" data-boat-id="${e._id}">
                <span>🔄</span>
                Restaurer
              </button>`}
          </div>
        </div>
      </div>
    `}getStatusText(e){return{available:"Disponible",booked:"Réservé",maintenance:"Maintenance",inactive:"Inactif"}[e]||"Inconnu"}getTypeText(e){return{sailboat:"Voilier",motorboat:"Bateau à moteur",catamaran:"Catamaran",yacht:"Yacht",other:"Autre"}[e]||e}async filterBoats(){var o,a,s;const e=(o=document.getElementById("status-filter"))==null?void 0:o.value,t=(a=document.getElementById("type-filter"))==null?void 0:a.value,r=(s=document.getElementById("search-input"))==null?void 0:s.value;try{this.showLoadingState();const n={};e&&(n.status=e),t&&(n.type=t),r&&(n.search=r);const i=await this.boatService.getOwnerBoats(n);i.success&&(this.displayBoats(i.data.boats),this.updatePagination(i.data.pagination))}catch(n){console.error("Erreur lors du filtrage:",n),this.showErrorState("Erreur lors du filtrage des bateaux")}}debounceSearch(){clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout(()=>{this.filterBoats()},500)}setViewMode(e){const t=document.getElementById("boats-grid"),r=document.getElementById("grid-view-btn"),o=document.getElementById("list-view-btn");t&&(t.className=e==="grid"?"boats-grid":"boats-grid list-view"),r&&r.classList.toggle("active",e==="grid"),o&&o.classList.toggle("active",e==="list")}async changePage(e){console.log("Changement de page:",e)}updatePagination(e){const t=document.getElementById("pagination"),r=document.getElementById("page-info"),o=document.getElementById("prev-page-btn"),a=document.getElementById("next-page-btn");!t||!e||(t.style.display=e.pages>1?"flex":"none",r&&(r.textContent=`Page ${e.page} sur ${e.pages}`),o&&(o.disabled=e.page<=1),a&&(a.disabled=e.page>=e.pages))}async editBoat(e){try{const t=await this.boatService.getBoatById(e);if(t.success){const r=t.data.boat;this.showEditBoatModal(r)}else throw new Error(t.message)}catch(t){console.error("Erreur lors de la récupération du bateau:",t),this.uiManager.showNotification(`Erreur: ${t.message}`,"error")}}manageImages(e){this.uiManager.showNotification("Fonctionnalité de gestion d'images en cours de développement","info")}async deleteBoat(e){if(confirm("Êtes-vous sûr de vouloir supprimer ce bateau ?"))try{if(!this.currentUser)throw new Error("Vous devez être connecté pour supprimer un bateau");const t=this.storageManager.getToken();if(!t)throw new Error("Token d'authentification manquant. Veuillez vous reconnecter.");console.log("🗑️ [DELETE BOAT] Tentative de suppression du bateau:",e),console.log("🔐 [DELETE BOAT] Token présent:",t?"Oui":"Non"),console.log("👤 [DELETE BOAT] Utilisateur connecté:",this.currentUser?this.currentUser.email:"Non"),console.log("👤 [DELETE BOAT] User ID:",this.currentUser?this.currentUser._id:"Non"),console.log("👤 [DELETE BOAT] User Role:",this.currentUser?this.currentUser.role:"Non");const r=await this.boatService.deleteBoat(e);if(r.success)this.uiManager.showNotification("Bateau supprimé avec succès","success"),await this.loadBoatManagementData();else throw new Error(r.message)}catch(t){console.error("❌ [DELETE BOAT] Erreur lors de la suppression:",t),t.message.includes("Authentification requise")||t.message.includes("Token")?(this.uiManager.showNotification("Session expirée. Veuillez vous reconnecter.","error"),setTimeout(()=>{window.location.href="index.html"},2e3)):this.uiManager.showNotification(`Erreur: ${t.message}`,"error")}}async restoreBoat(e){try{const t=await this.boatService.restoreBoat(e);if(t.success)this.uiManager.showNotification("Bateau restauré avec succès","success"),await this.loadBoatManagementData();else throw new Error(t.message)}catch(t){console.error("Erreur lors de la restauration:",t),this.uiManager.showNotification(`Erreur: ${t.message}`,"error")}}showAddBoatModal(){this.uiManager.showModal("add-boat-modal")}showEditBoatModal(e){this.populateEditForm(e),this.uiManager.showModal("edit-boat-modal")}populateEditForm(e){const t=document.getElementById("edit-boat-name"),r=document.getElementById("edit-boat-type"),o=document.getElementById("edit-boat-category"),a=document.getElementById("edit-boat-description"),s=document.getElementById("edit-boat-length"),n=document.getElementById("edit-boat-width"),i=document.getElementById("edit-boat-capacity"),c=document.getElementById("edit-boat-city"),g=document.getElementById("edit-boat-marina"),d=document.getElementById("edit-boat-price"),l=document.getElementById("edit-boat-deposit"),u=document.getElementById("edit-boat-form");t&&(t.value=e.name||""),r&&(r.value=e.type||""),o&&(o.value=e.category||""),a&&(a.value=e.description||""),s&&(s.value=e.length||""),n&&(n.value=e.width||""),i&&(i.value=e.capacity||""),c&&(c.value=e.city||""),g&&(g.value=e.marina||""),d&&(d.value=e.pricePerDay||""),l&&(l.value=e.deposit||""),u&&(u.dataset.boatId=e._id),this.displayExistingImages(e.images||[])}displayExistingImages(e){const t=document.getElementById("edit-image-preview-container");t&&(t.innerHTML="",e&&e.length>0&&e.forEach((r,o)=>{const a=document.createElement("div");a.className="image-preview-item existing",a.innerHTML=`
          <img src="${r}" alt="Image du bateau">
          <button type="button" class="remove-image-btn" onclick="app.removeExistingImage(${o})">×</button>
        `,t.appendChild(a)}))}async editBoat(e){var t,r;console.log("🔄 Édition du bateau:",e);try{const o=await this.boatService.getBoatById(e),a=o.data||o;if(!a){(t=this.uiManager)==null||t.showNotification("Bateau non trouvé","error");return}this.showEditBoatModal(a)}catch(o){console.error("Erreur lors de l'édition du bateau:",o),(r=this.uiManager)==null||r.showNotification("Erreur lors du chargement du bateau","error")}}async deleteBoat(e){var t,r;console.log("🗑️ Suppression du bateau:",e);try{const o=await this.boatService.getBoatById(e),a=o.data||o;if(!a){(t=this.uiManager)==null||t.showNotification("Bateau non trouvé","error");return}this.showDeleteBoatModal(a)}catch(o){console.error("Erreur lors de la suppression du bateau:",o),(r=this.uiManager)==null||r.showNotification("Erreur lors du chargement du bateau","error")}}async manageImages(e){var t,r;console.log("🖼️ Gestion des images du bateau:",e);try{const o=await this.boatService.getBoatById(e),a=o.data||o;if(!a){(t=this.uiManager)==null||t.showNotification("Bateau non trouvé","error");return}this.showImagesModal(a)}catch(o){console.error("Erreur lors de la gestion des images:",o),(r=this.uiManager)==null||r.showNotification("Erreur lors du chargement du bateau","error")}}async restoreBoat(e){var t,r;console.log("🔄 Restauration du bateau:",e);try{await this.boatService.updateBoat(e,{isActive:!0}),(t=this.uiManager)==null||t.showNotification("Bateau restauré avec succès","success"),this.loadBoats()}catch(o){console.error("Erreur lors de la restauration du bateau:",o),(r=this.uiManager)==null||r.showNotification("Erreur lors de la restauration","error")}}showEditBoatModal(e){console.log("📝 Affichage de la modale d'édition pour:",e.name);const t=document.getElementById("edit-boat-modal"),r=document.getElementById("edit-boat-form");if(!t||!r){console.error("Modale d'édition non trouvée");return}this.populateEditForm(r,e),t.style.display="flex";const o=document.getElementById("save-edit-btn");o&&(o.onclick=()=>this.saveBoatEdit(e._id))}populateEditForm(e,t){var r,o,a,s,n,i,c;e.innerHTML="",e.innerHTML=`
      <div class="form-row">
        <div class="form-group">
          <label for="edit-boat-name">Nom du bateau</label>
          <input type="text" id="edit-boat-name" value="${t.name||""}" required>
        </div>
        <div class="form-group">
          <label for="edit-boat-type">Type de bateau</label>
          <select id="edit-boat-type" required>
            <option value="voilier" ${t.type==="voilier"?"selected":""}>Voilier</option>
            <option value="catamaran" ${t.type==="catamaran"?"selected":""}>Catamaran</option>
            <option value="yacht" ${t.type==="yacht"?"selected":""}>Yacht</option>
            <option value="bateau_moteur" ${t.type==="bateau_moteur"?"selected":""}>Bateau à moteur</option>
          </select>
        </div>
        <div class="form-group">
          <label for="edit-boat-category">Catégorie</label>
          <select id="edit-boat-category" required>
            <option value="standard" ${t.category==="standard"?"selected":""}>Standard</option>
            <option value="luxe" ${t.category==="luxe"?"selected":""}>Luxe</option>
            <option value="economique" ${t.category==="economique"?"selected":""}>Économique</option>
          </select>
        </div>
      </div>
      
      <div class="form-group">
        <label for="edit-boat-description">Description</label>
        <textarea id="edit-boat-description" rows="4">${t.description||""}</textarea>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="edit-boat-length">Longueur (m)</label>
          <input type="number" id="edit-boat-length" value="${((r=t.specifications)==null?void 0:r.length)||""}" step="0.1" min="1" max="100" required>
        </div>
        <div class="form-group">
          <label for="edit-boat-width">Largeur (m)</label>
          <input type="number" id="edit-boat-width" value="${((o=t.specifications)==null?void 0:o.width)||""}" step="0.1" min="1" max="20" required>
        </div>
        <div class="form-group">
          <label for="edit-boat-capacity">Capacité (personnes)</label>
          <input type="number" id="edit-boat-capacity" value="${((a=t.capacity)==null?void 0:a.maxPeople)||""}" min="1" max="50" required>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="edit-boat-city">Ville</label>
          <input type="text" id="edit-boat-city" value="${((s=t.location)==null?void 0:s.city)||""}" required>
        </div>
        <div class="form-group">
          <label for="edit-boat-marina">Marina</label>
          <input type="text" id="edit-boat-marina" value="${((n=t.location)==null?void 0:n.marina)||""}" required>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="edit-boat-daily-rate">Prix par jour (€)</label>
          <input type="number" id="edit-boat-daily-rate" value="${((i=t.pricing)==null?void 0:i.dailyRate)||""}" min="50" step="10" required>
        </div>
        <div class="form-group">
          <label for="edit-boat-security-deposit">Caution (€)</label>
          <input type="number" id="edit-boat-security-deposit" value="${((c=t.pricing)==null?void 0:c.securityDeposit)||""}" min="0" step="50" required>
        </div>
      </div>
    `}async saveBoatEdit(e){try{console.log("💾 Sauvegarde de l'édition du bateau:",e);const t={name:document.getElementById("edit-boat-name").value,type:document.getElementById("edit-boat-type").value,category:document.getElementById("edit-boat-category").value,description:document.getElementById("edit-boat-description").value,specifications:{length:parseFloat(document.getElementById("edit-boat-length").value),width:parseFloat(document.getElementById("edit-boat-width").value),fuelType:"diesel"},capacity:{maxPeople:parseInt(document.getElementById("edit-boat-capacity").value)},location:{city:document.getElementById("edit-boat-city").value,marina:document.getElementById("edit-boat-marina").value,country:"France"},pricing:{dailyRate:parseInt(document.getElementById("edit-boat-daily-rate").value),securityDeposit:parseInt(document.getElementById("edit-boat-security-deposit").value),currency:"EUR"}};await this.boatService.updateBoat(e,t),this.uiManager.showNotification("Bateau mis à jour avec succès","success"),document.getElementById("edit-boat-modal").style.display="none",this.loadBoats()}catch(t){console.error("Erreur lors de la sauvegarde:",t),this.uiManager.showNotification("Erreur lors de la sauvegarde","error")}}showDeleteBoatModal(e){var a,s;console.log("🗑️ Affichage de la modale de suppression pour:",e.name);const t=document.getElementById("delete-boat-modal"),r=document.getElementById("delete-boat-info");if(!t||!r){console.error("Modale de suppression non trouvée");return}r.innerHTML=`
      <div class="boat-info">
        <h4>${e.name}</h4>
        <p><strong>Type:</strong> ${this.getTypeText(e.type)}</p>
        <p><strong>Capacité:</strong> ${((a=e.capacity)==null?void 0:a.maxPeople)||0} personnes</p>
        <p><strong>Tarif:</strong> ${((s=e.pricing)==null?void 0:s.dailyRate)||0}€/jour</p>
      </div>
    `,t.style.display="flex";const o=document.getElementById("confirm-delete-btn");o&&(o.onclick=()=>this.confirmDeleteBoat(e._id))}async confirmDeleteBoat(e){var t;try{console.log("🗑️ Confirmation de suppression du bateau:",e);const r=((t=document.getElementById("force-delete-checkbox"))==null?void 0:t.checked)||!1;await this.boatService.deleteBoat(e,r),this.uiManager.showNotification("Bateau supprimé avec succès","success"),document.getElementById("delete-boat-modal").style.display="none",this.loadBoats()}catch(r){console.error("Erreur lors de la suppression:",r),this.uiManager.showNotification("Erreur lors de la suppression","error")}}showImagesModal(e){console.log("🖼️ Affichage de la modale de gestion des images pour:",e.name);const t=document.getElementById("images-modal"),r=document.getElementById("images-grid");if(!t||!r){console.error("Modale d'images non trouvée");return}this.displayBoatImages(r,e),t.style.display="flex";const o=document.getElementById("image-upload");o&&(o.onchange=a=>this.handleImageUpload(a,e._id))}displayBoatImages(e,t){const r=t.imageUrls||t.images||[];if(r.length===0){e.innerHTML='<p class="no-images">Aucune image disponible</p>';return}e.innerHTML=r.map((o,a)=>`
      <div class="image-item">
        <img src="${o.url||o}" alt="Image ${a+1}">
        <button class="delete-image-btn" onclick="window.app.deleteBoatImage('${t._id}', '${o.id||a}')">
          🗑️
        </button>
      </div>
    `).join("")}async handleImageUpload(e,t){const r=Array.from(e.target.files);if(r.length!==0)try{console.log("📤 Upload de",r.length,"image(s) pour le bateau:",t),await this.boatService.updateBoat(t,{},r),this.uiManager.showNotification("Images ajoutées avec succès","success");const o=await this.boatService.getBoatById(t),a=o.data||o,s=document.getElementById("images-grid");this.displayBoatImages(s,a)}catch(o){console.error("Erreur lors de l'upload des images:",o),this.uiManager.showNotification("Erreur lors de l'upload des images","error")}}async deleteBoatImage(e,t){try{console.log("🗑️ Suppression de l'image:",t,"du bateau:",e),await this.boatService.deleteBoatImage(e,t),this.uiManager.showNotification("Image supprimée avec succès","success");const r=await this.boatService.getBoatById(e),o=r.data||r,a=document.getElementById("images-grid");this.displayBoatImages(a,o)}catch(r){console.error("Erreur lors de la suppression de l'image:",r),this.uiManager.showNotification("Erreur lors de la suppression de l'image","error")}}closeModal(e){const t=document.getElementById(e);t&&(t.style.display="none")}initModalEvents(){document.addEventListener("click",e=>{if(e.target.classList.contains("modal-close")){const t=e.target.closest(".modal");t&&(t.style.display="none")}}),document.addEventListener("click",e=>{e.target.classList.contains("modal")&&(e.target.style.display="none")}),document.addEventListener("keydown",e=>{if(e.key==="Escape"){const t=document.querySelector('.modal[style*="flex"]');t&&(t.style.display="none")}})}}document.addEventListener("DOMContentLoaded",()=>{window.app=new _,window.app&&window.app.initModalEvents()});
